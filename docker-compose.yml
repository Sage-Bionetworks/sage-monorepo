version: '3.8'

services:
  challenge-mongodb:
    image: sagebionetworks/challenge-mongodb:latest
    container_name: challenge-mongodb
    restart: always
    env_file:
      - ./apps/challenge-mongodb/.env
    networks:
      - openchallenges
    ports:
      - "27017:27017"
    volumes:
      - challenge-mongodb:/data/db

  openchallenges-api:
    image: sagebionetworks/openchallenges-api:latest
    container_name: openchallenges-api
    restart: always
    env_file:
      - ./apps/api/.env
    environment:
      - DB_DOMAIN=challenge-mongodb
    networks:
      - openchallenges
    ports:
      - "8080:8080"
    depends_on:
      - challenge-mongodb

  openchallenges-web-app:
    image: sagebionetworks/openchallenges-web-app:latest
    container_name: openchallenges-web-app
    restart: always
    env_file:
      - ./apps/web-app/.env
    environment:
      - SERVICE_HOST=openchallenges-api
      - SERVICE_PORT=8080
    networks:
      - openchallenges
    ports:
      - "80:80"
    depends_on:
      - openchallenges-api
      - challenge-keycloak

  challenge-keycloak:
    image: sagebionetworks/challenge-keycloak:latest
    container_name: challenge-keycloak
    restart: always
    env_file:
      - ./apps/challenge-keycloak/.env
    volumes:
      - ./apps/challenge-keycloak/data/h2:/opt/keycloak/data/h2
    networks:
      - openchallenges
    ports:
      - "8081:8080"
    command: start-dev
    depends_on:
      - challenge-postgresql

  challenge-postgresql:
    image: sagebionetworks/challenge-postgresql:latest
    container_name: challenge-postgresql
    restart: always
    env_file:
      - ./apps/challenge-postgresql/.env
    volumes:
      - challenge-postgresql:/var/lib/postgresql/data
      - ./apps/challenge-postgresql/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
    networks:
      - openchallenges
    ports:
      - "5432:5432"

networks:
  openchallenges:

volumes:
  challenge-mongodb:
    name: challenge-mongodb
  challenge-postgresql:
    name: challenge-postgresql