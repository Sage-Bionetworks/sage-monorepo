# Reusable workflow: Validates storybook builds without deploying.
# Called by build-deploy-docs.yml for PR validation.

name: Build Storybook

on:
  workflow_call:
    inputs:
      build_composite:
        description: 'Whether to build the composite storybook'
        required: true
        type: boolean
      storybooks:
        description: 'Individual storybooks to build (space-separated). Ignored if build_composite is true.'
        required: false
        type: string
        default: ''

jobs:
  build:
    timeout-minutes: 15
    runs-on: ubuntu-22.04-4core-16GBRAM-150GBSSD
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v4

      - name: Set up dev container
        uses: ./.github/actions/setup-dev-container

      - name: Build composite storybook
        if: inputs.build_composite
        run: |
          devcontainer exec --workspace-folder ../sage-monorepo bash -c ". ./dev-env.sh \
              && nx build-static-composition storybook"

      - name: Build individual storybooks
        if: ${{ !inputs.build_composite && inputs.storybooks != '' }}
        env:
          STORYBOOKS: ${{ inputs.storybooks }}
        run: |
          for storybook in $STORYBOOKS; do
            echo "=== Building ${storybook} storybook ==="
            devcontainer exec --workspace-folder ../sage-monorepo bash -c ". ./dev-env.sh \
                && STORYBOOK_STATIC_BUILD=true nx build-storybook ${storybook}-storybook --outputDir=dist/storybook/storybook/${storybook}"
          done

      - name: Remove the dev container
        if: always()
        run: docker rm -f sage_devcontainer
