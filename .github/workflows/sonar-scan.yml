name: Sonar Scan

on:
  push:
    branches:
      - main
      - 'agora/**'
      - 'iatlas/**'
      - 'openchallenges/**'
      - 'sage-monorepo/**'
      - 'schematic/**'
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

jobs:
  sonar:
    runs-on: ubuntu-latest
    steps:
      - name: Check if the label `sonar-scan-approved` exists
        if: ${{ github.event_name == 'pull_request_target' && contains(github.event.pull_request.labels.*.name, 'sonar-scan-approved') != true }}
        run: echo "Add the label 'sonar-scan-approved' to this PR to enable Sonar scan"; exit 1

      - uses: actions/checkout@v4
        name: Checkout
        with:
          # We need to fetch all branches and commits so that Nx affected has a base to compare
          # against.
          fetch-depth: 0

      - name: Check if the HEAD is detached
        # Buildx does not work on a detached HEAD
        id: is_head_detached
        run: |
          # return exit code 1 if the head is detached
          git symbolic-ref -q HEAD > /dev/null 2>&1
          is_detached=$?
          echo "detached=$is_detached" >> "$GITHUB_OUTPUT"
          echo $is_detached

      - name: Switch from the detached HEAD of the merge commit to a new branch
        if: ${{ steps.is_head_detached.outputs.detached == '1' }}
        run: git switch -c new-branch

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v4

      - name: Set up the dev container
        env:
          SONAR_PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        uses: ./.github/actions/setup-dev-container

      - name: Scan the affected projects with Sonar
        run: |
          devcontainer exec --workspace-folder ../sage-monorepo bash -c ". ./dev-env.sh \
            && nx affected --target=sonar"