name: Scan affected projects with Sonar
on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

env:
  HEAD_REF: ${{ github.event.pull_request.head.ref }}
  HEAD_REPOSITORY: ${{ github.event.pull_request.head.repo.full_name }}

jobs:
  sonar:
    if: contains(github.event.pull_request.labels.*.name, 'sonar-scan-approved')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        name: Checkout ${{ env.HEAD_REPOSITORY }}:${{ env.HEAD_REF }}
        with:
          ref: ${{ env.HEAD_REF }}
          repository: ${{ env.HEAD_REPOSITORY }}
          fetch-depth: 0

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v3

      - name: Set up the dev container
        env:
          SONAR_PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        uses: ./.github/actions/setup-dev-container

      - name: Scan the affected projects with Sonar
        run: |
          devcontainer exec --workspace-folder ../sage-monorepo bash -c ". ./dev-env.sh \
            && nx affected --target=sonar"