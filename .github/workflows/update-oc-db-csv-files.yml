name: Update OpenChallenges DB files
on:
  schedule:
    - cron: "0 0 * * *"  # daily at 00:00 UTC 
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:

      # schematic only supports Python 3.9 and 3.10, so we will need
      # to specifically use one of these versions.
      - name: Install system dependencies
        run: |
          sudo add-apt-repository ppa:deadsnakes/ppa
          sudo apt-get update
          sudo apt-get install -y pip python3.10-venv libcurl4-openssl-dev

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: false
          fetch-depth: 0

      - name: Find existing DB branch if available
        run: |
          echo "BRANCH=$(git branch -r | \
                         grep "db-update-*" | \
                         sed -e 's/origin\///' | \
                         sed -e 's/^[ \t]*//')" >> $GITHUB_ENV

      - name: Checkout existing DB branch if available
        if: ${{ env.BRANCH != '' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH }}
          persist-credentials: false

      - name: Get current date
        run: |
          echo "TODAY=$(date +"%Y-%m-%d")" >> $GITHUB_ENV

      - name: Create new branch name if needed
        if: ${{ env.BRANCH == '' }}
        run : |
          echo "BRANCH=db-update-${{ env.TODAY }}" >> $GITHUB_ENV
          echo "PR_NEEDED="true"" >> $GITHUB_ENV

      - name: Create Google Service credentials file
        uses: jsdaniell/create-json@v1.2.3
        with:
          name: "service_account.json"
          json: ${{ secrets.GOOGLE_CLIENT_JSON }}

      - name: Update dump files
        run: |
          python3 -m pip install --upgrade pip
          pip install gspread pandas numpy
          python3 apps/openchallenges/db-update/update_db_csv.py

      # - name: Install schematic and validate files
      #   shell: bash
      #   run: |
      #     python3.10 -m venv .venv
      #     chmod 755 .venv/bin/activate
      #     source .venv/bin/activate
      #     pip3.10 install schematicpy

      - name: Commit files
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git config advice.addIgnoredFile false
          git add .
          git commit -m "${{ env.TODAY }}: add latest CSV dump files"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: db-update-${{ env.TODAY }}

      - name: Create pull request
        if: ${{ env.PR_NEEDED == 'true' }}
        run: |
          gh pr create -B main -H ${{ env.BRANCH }} \
            --title 'chore(openchallenges): ${{ env.TODAY }} DB update' \
            --body 'Daily OC datebase update(s)' \
            --label sonar-scan-approved
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    