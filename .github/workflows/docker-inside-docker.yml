name: 'Test Docker inside Docker'
on:
  push:
    branches:
      - main
  pull_request:

env:
  NX_BRANCH: ${{ github.event.number }}
  NX_RUN_GROUP: ${{ github.run_id }}
  NX_CLOUD_AUTH_TOKEN: ${{ secrets.NX_CLOUD_AUTH_TOKEN }}
  NX_CLOUD_ENCRYPTION_KEY: ${{ secrets.NX_CLOUD_ENCRYPTION_KEY }}
  NX_CLOUD_ENV_NAME: 'linux'

jobs:
  pr:
    runs-on: ubuntu-latest
    # container:
    #   image: sagebionetworks/sage-devcontainer:7f9d3e3
    #   options: --user root
    # Runs this job if triggered by a PR and if at least one of these conditions are true:
    # - the PR originate from a fork
    # - the branch name does not start with `renovate/` since we know that the workflow would have
    #   been already triggered by the `push` event.
    if: |
      github.event_name == 'pull_request'
        && (
          github.event.pull_request.head.repo.full_name !=
            github.event.pull_request.base.repo.full_name
          || !startsWith(github.head_ref, 'renovate/')
        )
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0

      - name: Prevent git error about detected dubious ownership
        run: git config --global --add safe.directory /__w/sage-monorepo/sage-monorepo

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v3

      - name: Setup Node.js cache
        id: cache-node
        uses: actions/cache@v3
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set buildx as the default builder
        run: docker buildx install

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-single-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-single-buildx

      - name: Show Docker version
        run: docker --version

      - name: Show images on the host
        run: docker images

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli@0.25.2

      - name: Show devcontainer CLI version
        run: devcontainer --version

      - name: Run task inside the Sage Monorepo dev container
        run: |
          # So that the images built inside the dev container are available on the host (i.e.
          # outside the dev container)
          ./tools/switch-devcontainer-to-docker-outside-of-docker.sh

          # Step outside of the repository
          cd ..

          # Start the dev container
          devcontainer up --workspace-folder sage-monorepo

          # # Build the images
          # devcontainer exec --workspace-folder sage-monorepo bash -c \
          #   ". ./dev-env.sh \
          #   && workspace-install \
          #   && openchallenges-build-images"

      - name: Create hello file
        run: devcontainer exec --workspace-folder sage-monorepo bash -c "touch ~/hello"

      - name: Show hello file
        run: devcontainer exec --workspace-folder sage-monorepo bash -c "ls ~/hello"

      - name: Show images available to the host
        run: docker images
