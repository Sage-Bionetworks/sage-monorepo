openapi: 3.0.3
info:
  version: 1.0.0
  title: BixArena Auth Service
  description: Advance bioinformatics by evaluating and ranking AI agents.
  license:
    name: Apache 2.0
    url: https://github.com/Sage-Bionetworks/sage-monorepo/blob/main/LICENSE.txt
  contact:
    name: Support
    url: https://github.com/Sage-Bionetworks/sage-monorepo
servers:
  - url: http://localhost
security:
  - jwtBearer: []
tags:
  - name: Auth
    description: Authentication and token minting operations.
paths:
  /auth/login:
    get:
      x-anonymous-access: true
      tags:
        - Auth
      summary: Start Synapse OIDC authorization code flow
      description: Initiates the OIDC login by redirecting the user to Synapse with state and nonce.
      operationId: login
      security: []
      responses:
        '204':
          description: Flow started (no content; clients should follow redirect)
        '302':
          description: Redirect to Synapse login
        '400':
          $ref: '#/components/responses/BadRequest'
  /auth/callback:
    get:
      x-anonymous-access: true
      tags:
        - Auth
      summary: OIDC redirect callback
      description: Handles redirect from Synapse, validates state and nonce, establishes authenticated session.
      operationId: callback
      security: []
      parameters:
        - in: query
          name: code
          required: true
          schema:
            type: string
        - in: query
          name: state
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
  /auth/logout:
    post:
      x-anonymous-access: false
      tags:
        - Auth
      summary: Logout current session
      description: Invalidate the current authenticated session. Requires an active session.
      operationId: logout
      responses:
        '204':
          description: Logged out successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
  /oauth2/token:
    post:
      x-anonymous-access: true
      tags:
        - Auth
      summary: Mint short-lived internal JWT
      description: |
        Exchanges an authenticated session (cookie) for an internal JWT (OAuth2-style endpoint).

        The optional audience parameter specifies the target service for the JWT.
      operationId: token
      security: []
      parameters:
        - in: query
          name: audience
          required: false
          schema:
            type: string
            enum:
              - urn:bixarena:auth
              - urn:bixarena:api
              - urn:bixarena:ai
          description: |
            Target audience for the JWT. If not specified, defaults to urn:bixarena:auth.
      responses:
        '200':
          description: Access token response
          content:
            application/json:
              schema:
                type: object
                required:
                  - access_token
                  - token_type
                  - expires_in
                properties:
                  access_token:
                    type: string
                  token_type:
                    type: string
                    enum:
                      - Bearer
                  expires_in:
                    type: integer
                    example: 600
        '401':
          $ref: '#/components/responses/Unauthorized'
  /userinfo:
    get:
      tags:
        - Auth
      summary: Get current user profile
      description: |
        Returns the authenticated user's profile information.
        This is an OIDC-compliant UserInfo endpoint that provides details about the currently authenticated user.

        Requires a valid JWT obtained via the `/token` endpoint or an active session.
      operationId: getUserInfo
      responses:
        '200':
          description: User profile information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'
        '401':
          $ref: '#/components/responses/Unauthorized'
  /.well-known/jwks.json:
    get:
      x-anonymous-access: true
      tags:
        - Auth
      summary: JSON Web Key Set
      description: Returns the public keys used to verify internally issued JWTs.
      operationId: getJwks
      security: []
      responses:
        '200':
          description: JWKS document
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      type: object
        '400':
          $ref: '#/components/responses/BadRequest'
components:
  securitySchemes:
    jwtBearer:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Short-lived internal JWT issued by this service after authentication through Synapse or (later) an API key exchange.
  schemas:
    BasicError:
      type: object
      description: Problem details (tools.ietf.org/html/rfc7807)
      properties:
        title:
          type: string
          description: A human readable documentation for the problem type
        status:
          type: integer
          description: The HTTP status code
        detail:
          type: string
          description: A human readable explanation specific to this occurrence of the problem
        type:
          type: string
          description: An absolute URI that identifies the problem type
        instance:
          type: string
          description: An absolute URI that identifies the specific occurrence of the problem
      required:
        - title
        - status
    UserInfo:
      type: object
      description: OIDC-compliant user information response
      properties:
        sub:
          type: string
          description: Subject identifier - the Synapse user ID
          example: '3350396'
        preferred_username:
          type: string
          description: Preferred username for display
          example: john.doe
        email:
          type: string
          format: email
          description: User's email address
          example: john.doe@example.com
        email_verified:
          type: boolean
          description: Whether the email address has been verified
          example: true
        roles:
          type: array
          description: User roles assigned within BixArena
          items:
            type: string
            enum:
              - user
              - admin
          example:
            - user
      required:
        - sub
  responses:
    BadRequest:
      description: Invalid request
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/BasicError'
    Unauthorized:
      description: Unauthorized
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/BasicError'
x-oauth2-audience: urn:bixarena:auth
