#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# From the post-checkout docs https://git-scm.com/docs/githooks#_post_checkout
# The hook is given three parameters:
#  - the ref of the previous HEAD
#  - the ref of the new HEAD (which may or may not have changed)
#  - a flag indicating whether the checkout was:
#     - a branch checkout (changing branches, flag=1)
#     - a file checkout (retrieving a file from the index, flag=0).

# When the third script parameter is "1" we are executing a branch checkout
if [ "$3" = "1" ]; then

  expected_yarn_lock_hash=$(sha256sum yarn.lock | awk '{print $1}')
  current_yarn_lock_hash=$DEVCONTAINER_YARN_LOCK_HASH

  if [[ "$s1" != "$s2" ]]; then
    echo "ðŸ“¦ Install Node.js dependencies"
    yarn install --frozen-lockfile
    # TODO: Persist the variable across sessions
    export DEVCONTAINER_YARN_LOCK_HASH=$expected_yarn_lock_hash
  fi

  # Install the Java dependencies.
  # yarn nx run-many --target=prepare-java --parallel=1

  # Notify the developer when a different dev container must be used.
  node tools/check-devcontainer-version.js
fi
