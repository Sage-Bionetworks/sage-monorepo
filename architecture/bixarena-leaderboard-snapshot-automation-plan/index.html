
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A development environment for building robust apps faster.">
      
      
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>BixArena Leaderboard Snapshot Automation Implementation Plan - Sage Monorepo</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      
  
  
    
      
      
    
  
    
      
      
    
  
  
  <style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M1%207.775V2.75C1%201.784%201.784%201%202.75%201h5.025c.464%200%20.91.184%201.238.513l6.25%206.25a1.75%201.75%200%200%201%200%202.474l-5.026%205.026a1.75%201.75%200%200%201-2.474%200l-6.25-6.25A1.75%201.75%200%200%201%201%207.775m1.5%200c0%20.066.026.13.073.177l6.25%206.25a.25.25%200%200%200%20.354%200l5.025-5.025a.25.25%200%200%200%200-.354l-6.25-6.25a.25.25%200%200%200-.177-.073H2.75a.25.25%200%200%200-.25.25ZM6%205a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M0%208a8%208%200%201%201%2016%200A8%208%200%200%201%200%208m8-6.5a6.5%206.5%200%201%200%200%2013%206.5%206.5%200%200%200%200-13M6.5%207.75A.75.75%200%200%201%207.25%207h1a.75.75%200%200%201%20.75.75v2.75h.25a.75.75%200%200%201%200%201.5h-2a.75.75%200%200%201%200-1.5h.25v-2h-.25a.75.75%200%200%201-.75-.75M8%206a1%201%200%201%201%200-2%201%201%200%200%201%200%202%22/%3E%3C/svg%3E');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bixarena-leaderboard-snapshot-automation-implementation-plan" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Sage Monorepo" class="md-header__button md-logo" aria-label="Sage Monorepo" data-md-component="logo">
      
  <img src="../../images/sage.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sage Monorepo
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              BixArena Leaderboard Snapshot Automation Implementation Plan
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Sage-Bionetworks/sage-monorepo" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    sage-monorepo
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../updates/" class="md-tabs__link">
          
  
  
  Updates

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../blog/" class="md-tabs__link">
        
  
  
    
  
  Blog

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../products/services/" class="md-tabs__link">
          
  
  
  Products

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../develop/quick-start/" class="md-tabs__link">
          
  
  
  Develop

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/overview/" class="md-tabs__link">
          
  
  
  API

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../resources/faq/" class="md-tabs__link">
          
  
  
  Resources

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../technical-documentation-overview/" class="md-tabs__link">
          
  
  
  Technical Documentation

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Sage Monorepo" class="md-nav__button md-logo" aria-label="Sage Monorepo" data-md-component="logo">
      
  <img src="../../images/sage.png" alt="logo">

    </a>
    Sage Monorepo
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Sage-Bionetworks/sage-monorepo" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    sage-monorepo
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Updates
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Updates
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../updates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../updates/september-2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    September 2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../updates/june-2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    June 2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../updates/may-2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    May 2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../updates/april-2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    April 2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../updates/march-2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    March 2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../updates/february-2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    February 2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Products
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Products
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../products/services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Service Catalog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../products/agora/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agora
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/bixarena/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BixArena
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/model-ad/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model-AD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../products/openchallenges/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenChallenges
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/synapse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Synapse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Develop
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Develop
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/remote-dev/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Remote Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/architecture/what-is-nx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Nx Workspace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/architecture/what-is-devcontainer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dev Containers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/architecture/terraform-infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terraform Infrastructure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_1" >
        
          
          <label class="md-nav__link" for="__nav_5_4_1" id="__nav_5_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Angular
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Angular
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/angular/add-app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create App
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/angular/add-api-client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add API Client
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/angular/add-component/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add Component
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/angular/add-library/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add Library
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_2" >
        
          
          <label class="md-nav__link" for="__nav_5_4_2" id="__nav_5_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Java
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Java
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/java/add-library/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add Library
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/java/add-rest-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add REST API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_3" >
        
          
          <label class="md-nav__link" for="__nav_5_4_3" id="__nav_5_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Python
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Python
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/python/add-rest-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add REST API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4_4" id="__nav_5_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Docker
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Docker
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/docker/new-project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    New Project
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_5" >
        
          
          <label class="md-nav__link" for="__nav_5_4_5" id="__nav_5_4_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    R
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    R
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/r/new-project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    New Project
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_6" >
        
          
          <label class="md-nav__link" for="__nav_5_4_6" id="__nav_5_4_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Terraform
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Terraform
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/terraform/create-backend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create Backend
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/tutorials/terraform/create-reusable-module/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create Reusable Module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Maintenance
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Maintenance
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/maintenance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/maintenance/java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/maintenance/node/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Node / TypeScript
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/maintenance/python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/maintenance/r/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    R
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/maintenance/docker-images/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Docker Base Images
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/maintenance/dev-container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dev Container
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/maintenance/security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Security & Compliance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/maintenance/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting & FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Advanced
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Advanced
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/advanced/developing-on-a-remote-host/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Remote Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/advanced/creating-a-commit-with-multiple-authors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-author Commits
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/agora/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agora
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/bixarena/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BixArena
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/model-ad/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model-AD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/openchallenges/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenChallenges
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/synapse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Synapse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Resources
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Resources
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/bug-report/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bug Reports
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/feature-requests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Feature Requests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributions/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/oc-schemas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenChallenges Schemas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Technical Documentation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Technical Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-documentation-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../submission-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Submission Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rfcs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RFCs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADRs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Diagram
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Architecture
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-measures-by-component" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Measures by Component
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Measures by Component">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-lambda-function-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Lambda Function Security
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-ai-service-api-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. AI Service API Security
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-database-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Database Security
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-audit-logging-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Audit Logging &amp; Monitoring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Checklist
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-1-lambda-function-packaging-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 1: Lambda Function Packaging Options
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 1: Lambda Function Packaging Options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option-a-container-image-docker-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option A: Container Image (Docker) ‚≠ê RECOMMENDED
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-b-zip-archive-with-lambda-layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option B: Zip Archive with Lambda Layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-c-zip-with-inline-bundling-no-layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option C: Zip with Inline Bundling (No Layers)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendation-option-a-container-image" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recommendation: Option A - Container Image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2-detailed-implementation-plan" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 2: Detailed Implementation Plan
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 2: Detailed Implementation Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-extract-shared-logic-library" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 1: Extract Shared Logic Library
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 1: Extract Shared Logic Library">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-motivation" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 Motivation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-create-domain-specific-library-package" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Create Domain-Specific Library Package
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-migrate-existing-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Migrate Existing Code
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-lambda-function-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 2: Lambda Function Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 2: Lambda Function Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-lambda-handler-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Lambda Handler Code
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-cdk-stack-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 CDK Stack Implementation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-ai-service-endpoint-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 3: AI Service Endpoint Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 3: AI Service Endpoint Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-add-admin-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Add Admin Endpoint
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-update-ai-service-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Update AI Service Dependencies
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-database-connection-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 4: Database Connection Strategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 4: Database Connection Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option-a-rds-proxy-recommended-for-lambda" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option A: RDS Proxy (Recommended for Lambda)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-b-direct-connection-simpler-for-ai-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option B: Direct Connection (Simpler for AI Service)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-5-testing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 5: Testing Strategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 5: Testing Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-local-testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 Local Testing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-integration-testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 Integration Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-6-deployment-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 6: Deployment Workflow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 6: Deployment Workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-build-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Build Pipeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-cicd-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 CI/CD Integration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-7-monitoring-observability" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 7: Monitoring &amp; Observability
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 7: Monitoring &amp; Observability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-cloudwatch-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 CloudWatch Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-alarms" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 Alarms
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-slack-notifications" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 Slack Notifications
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-timeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Timeline
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Timeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#week-1-foundation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Week 1: Foundation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#week-2-lambda-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Week 2: Lambda Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#week-3-ai-service-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Week 3: AI Service Integration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#week-4-testing-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Week 4: Testing &amp; Documentation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cost-estimation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cost Estimation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cost Estimation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lambda-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Lambda Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rds-proxy-if-used" class="md-nav__link">
    <span class="md-ellipsis">
      
        RDS Proxy (if used)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloudwatch-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        CloudWatch Logs
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decisions-made" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decisions Made
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Next Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ready-to-begin-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ready to Begin Implementation ‚úÖ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommended-implementation-order" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recommended Implementation Order
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quick-start-command" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quick Start Command
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="bixarena-leaderboard-snapshot-automation-implementation-plan">BixArena Leaderboard Snapshot Automation Implementation Plan<a class="headerlink" href="#bixarena-leaderboard-snapshot-automation-implementation-plan" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>Implement automated daily leaderboard snapshot generation using a hybrid approach:</p>
<ul>
<li><strong>Primary</strong>: AWS Lambda function triggered by EventBridge (scheduled)</li>
<li><strong>Secondary</strong>: Protected API endpoint in AI service (on-demand)</li>
<li><strong>Shared</strong>: Core snapshot generation logic extracted from <code>bixarena-tools</code></li>
</ul>
<h2 id="architecture-diagram">Architecture Diagram<a class="headerlink" href="#architecture-diagram" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         Scheduled Execution                              ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  EventBridge Rule ‚îÄ‚îÄ&gt; Lambda Function ‚îÄ‚îÄ&gt; RDS Proxy ‚îÄ‚îÄ&gt; PostgreSQL      ‚îÇ
‚îÇ  (cron: daily 2 AM)   (leaderboard-      (connection   (bixarena DB)   ‚îÇ
‚îÇ                        snapshot-gen)      pooling)                       ‚îÇ
‚îÇ                            ‚îÇ                                             ‚îÇ
‚îÇ                            ‚îî‚îÄ‚îÄ&gt; SNS Topic ‚îÄ‚îÄ&gt; Slack Lambda ‚îÄ‚îÄ&gt; Slack    ‚îÇ
‚îÇ                                 (success/failure notifications)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        On-Demand Execution                               ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  API Gateway ‚îÄ‚îÄ&gt; AI Service ‚îÄ‚îÄ&gt; Lambda (async) ‚îÄ‚îÄ&gt; Returns 202          ‚îÇ
‚îÇ  (authenticated)  POST /admin/        ‚îÇ              with correlation_id‚îÇ
‚îÇ                   generate-           ‚îÇ                                  ‚îÇ
‚îÇ                   snapshot            ‚îî‚îÄ‚îÄ&gt; RDS Proxy ‚îÄ‚îÄ&gt; PostgreSQL     ‚îÇ
‚îÇ                                       ‚îî‚îÄ‚îÄ&gt; SNS ‚îÄ‚îÄ&gt; Slack notification    ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  Response: {&quot;correlation_id&quot;: &quot;...&quot;, &quot;status&quot;: &quot;initiated&quot;}             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ  Shared Logic                ‚îÇ
                              ‚îÇ  (bixarena-leaderboard)      ‚îÇ
                              ‚îÇ                              ‚îÇ
                              ‚îÇ - fetch_data()               ‚îÇ
                              ‚îÇ - compute_bradley_terry()    ‚îÇ
                              ‚îÇ - save_snapshot()            ‚îÇ
                              ‚îÇ - auto_publish=True          ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div>
<p><strong>Design Notes:</strong></p>
<ul>
<li>Lambda currently generates <strong>"overall"</strong> leaderboard daily</li>
<li>Extensible design: pass <code>leaderboard_id</code> parameter for future leaderboards</li>
<li>Auto-publish enabled by default (sets <code>visible=true</code>)</li>
<li>Slack notifications sent on both success and failure</li>
<li><strong>On-demand execution</strong>: Async Lambda invocation (returns immediately, no timeout issues)</li>
<li><strong>Metadata tracking</strong>: <code>trigger_source</code> (scheduled/api), <code>triggered_by</code> (user email), <code>correlation_id</code></li>
</ul>
<hr />
<h2 id="security-architecture">Security Architecture<a class="headerlink" href="#security-architecture" title="Permanent link">&para;</a></h2>
<h3 id="overview_1">Overview<a class="headerlink" href="#overview_1" title="Permanent link">&para;</a></h3>
<p>The leaderboard snapshot system implements defense-in-depth security with multiple layers:</p>
<ol>
<li><strong>Authentication &amp; Authorization</strong>: JWT-based API authentication with admin-only access</li>
<li><strong>IAM Least Privilege</strong>: Lambda and ECS task roles scoped to minimum necessary permissions</li>
<li><strong>Secrets Management</strong>: Database credentials stored in AWS Secrets Manager</li>
<li><strong>Network Isolation</strong>: Lambda in VPC private subnet, RDS Proxy with IAM authentication</li>
<li><strong>Input Validation</strong>: Whitelist-based validation of all Lambda inputs</li>
<li><strong>Audit Logging</strong>: CloudWatch logs with correlation IDs for traceability</li>
</ol>
<h3 id="security-measures-by-component">Security Measures by Component<a class="headerlink" href="#security-measures-by-component" title="Permanent link">&para;</a></h3>
<h4 id="1-lambda-function-security">1. Lambda Function Security<a class="headerlink" href="#1-lambda-function-security" title="Permanent link">&para;</a></h4>
<p><strong>IAM Execution Role</strong> (least privilege):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Lambda execution role with minimal permissions</span>
<span class="n">lambda_role</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">Role</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;SnapshotLambdaRole&quot;</span><span class="p">,</span>
    <span class="n">assumed_by</span><span class="o">=</span><span class="n">iam</span><span class="o">.</span><span class="n">ServicePrincipal</span><span class="p">(</span><span class="s2">&quot;lambda.amazonaws.com&quot;</span><span class="p">),</span>
    <span class="n">managed_policies</span><span class="o">=</span><span class="p">[</span>
        <span class="n">iam</span><span class="o">.</span><span class="n">ManagedPolicy</span><span class="o">.</span><span class="n">from_aws_managed_policy_name</span><span class="p">(</span>
            <span class="s2">&quot;service-role/AWSLambdaVPCAccessExecutionRole&quot;</span>
        <span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="c1"># Grant ONLY what&#39;s needed:</span>
<span class="n">db_secret</span><span class="o">.</span><span class="n">grant_read</span><span class="p">(</span><span class="n">lambda_role</span><span class="p">)</span>  <span class="c1"># Read DB credentials</span>
<span class="n">snapshot_events_topic</span><span class="o">.</span><span class="n">grant_publish</span><span class="p">(</span><span class="n">lambda_role</span><span class="p">)</span>  <span class="c1"># Publish to SNS</span>
<span class="n">rds_proxy</span><span class="o">.</span><span class="n">grant_connect</span><span class="p">(</span><span class="n">lambda_role</span><span class="p">,</span> <span class="s2">&quot;bixarena_user&quot;</span><span class="p">)</span>  <span class="c1"># RDS IAM auth</span>
</code></pre></div>
<p><strong>Network Security</strong> (VPC isolation):</p>
<div class="highlight"><pre><span></span><code><span class="n">snapshot_function</span> <span class="o">=</span> <span class="n">lambda_</span><span class="o">.</span><span class="n">DockerImageFunction</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="s2">&quot;SnapshotFunction&quot;</span><span class="p">,</span>
    <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
    <span class="n">vpc_subnets</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetSelection</span><span class="p">(</span>
        <span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PRIVATE_WITH_EGRESS</span>
    <span class="p">),</span>
    <span class="n">security_groups</span><span class="o">=</span><span class="p">[</span><span class="n">lambda_security_group</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># Security group: outbound to RDS only</span>
<span class="n">lambda_security_group</span><span class="o">.</span><span class="n">add_egress_rule</span><span class="p">(</span>
    <span class="n">peer</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Peer</span><span class="o">.</span><span class="n">security_group_id</span><span class="p">(</span><span class="n">rds_security_group</span><span class="o">.</span><span class="n">security_group_id</span><span class="p">),</span>
    <span class="n">connection</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Port</span><span class="o">.</span><span class="n">tcp</span><span class="p">(</span><span class="mi">5432</span><span class="p">),</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Allow Lambda to access RDS via proxy&quot;</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>Input Validation</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_inputs</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate and sanitize Lambda event inputs.&quot;&quot;&quot;</span>
    <span class="c1"># Whitelist allowed leaderboards</span>
    <span class="n">allowed_leaderboards</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">,</span> <span class="s2">&quot;open-source&quot;</span><span class="p">,</span> <span class="s2">&quot;multimodal&quot;</span><span class="p">]</span>
    <span class="n">leaderboard_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;leaderboard_id&quot;</span><span class="p">,</span> <span class="s2">&quot;overall&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leaderboard_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_leaderboards</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid leaderboard_id: </span><span class="si">{</span><span class="n">leaderboard_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validate bootstrap iterations (reasonable range)</span>
    <span class="n">num_bootstrap</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_bootstrap&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_bootstrap</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">num_bootstrap</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">or</span> <span class="n">num_bootstrap</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid num_bootstrap: </span><span class="si">{</span><span class="n">num_bootstrap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validate trigger source</span>
    <span class="n">trigger_source</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trigger_source&quot;</span><span class="p">,</span> <span class="s2">&quot;scheduled&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trigger_source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;scheduled&quot;</span><span class="p">,</span> <span class="s2">&quot;api&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid trigger_source: </span><span class="si">{</span><span class="n">trigger_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="2-ai-service-api-security">2. AI Service API Security<a class="headerlink" href="#2-ai-service-api-security" title="Permanent link">&para;</a></h4>
<p><strong>Authentication</strong> (JWT with admin role):</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_jwt_admin</span><span class="p">(</span>
    <span class="n">authorization</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="o">...</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate JWT and ensure user has admin role.&quot;&quot;&quot;</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">validate_jwt</span><span class="p">(</span><span class="n">authorization</span><span class="p">)</span>  <span class="c1"># Verify signature, expiry</span>

    <span class="c1"># Check admin role</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cognito:groups&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="s2">&quot;admin&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Admin role required for snapshot generation&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>  <span class="c1"># Return email for audit logging</span>
</code></pre></div>
<p><strong>Lambda Invocation Permission</strong> (scoped IAM):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># AI service ECS task role</span>
<span class="n">ai_service_task_role</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">Role</span><span class="o">.</span><span class="n">from_role_arn</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;AIServiceTaskRole&quot;</span><span class="p">,</span>
    <span class="n">role_arn</span><span class="o">=</span><span class="s2">&quot;arn:aws:iam::123456789012:role/BixArenaAIServiceTaskRole&quot;</span>
<span class="p">)</span>

<span class="c1"># Grant permission to invoke ONLY this specific Lambda</span>
<span class="n">snapshot_function</span><span class="o">.</span><span class="n">grant_invoke</span><span class="p">(</span><span class="n">ai_service_task_role</span><span class="p">)</span>

<span class="c1"># Generated policy:</span>
<span class="c1"># {</span>
<span class="c1">#   &quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="c1">#   &quot;Action&quot;: &quot;lambda:InvokeFunction&quot;,</span>
<span class="c1">#   &quot;Resource&quot;: &quot;arn:aws:lambda:us-east-1:123456789012:function:snapshot-gen&quot;</span>
<span class="c1"># }</span>
</code></pre></div>
<p><strong>Rate Limiting</strong> (API Gateway):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Prevent abuse of manual snapshot generation</span>
<span class="n">api_gateway</span><span class="o">.</span><span class="n">add_usage_plan</span><span class="p">(</span>
    <span class="s2">&quot;SnapshotAPIUsagePlan&quot;</span><span class="p">,</span>
    <span class="n">throttle</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;rate_limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># 10 requests per second</span>
        <span class="s2">&quot;burst_limit&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">quota</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># 100 requests per day</span>
        <span class="s2">&quot;period&quot;</span><span class="p">:</span> <span class="n">apigateway</span><span class="o">.</span><span class="n">Period</span><span class="o">.</span><span class="n">DAY</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></div>
<h4 id="3-database-security">3. Database Security<a class="headerlink" href="#3-database-security" title="Permanent link">&para;</a></h4>
<p><strong>Secrets Manager</strong> (no hardcoded credentials):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Database credentials in Secrets Manager</span>
<span class="n">db_secret</span> <span class="o">=</span> <span class="n">secretsmanager</span><span class="o">.</span><span class="n">Secret</span><span class="o">.</span><span class="n">from_secret_name_v2</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="s2">&quot;DatabaseSecret&quot;</span><span class="p">,</span>
    <span class="n">secret_name</span><span class="o">=</span><span class="s2">&quot;bixarena/rds/credentials&quot;</span>
<span class="p">)</span>

<span class="c1"># Lambda retrieves credentials at runtime</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_database_url</span><span class="p">():</span>
    <span class="n">secret_arn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DB_SECRET_ARN&quot;</span><span class="p">]</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;secretsmanager&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_secret_value</span><span class="p">(</span><span class="n">SecretId</span><span class="o">=</span><span class="n">secret_arn</span><span class="p">)</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;SecretString&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;postgresql://</span><span class="si">{</span><span class="n">secret</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">secret</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">secret</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">secret</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">secret</span><span class="p">[</span><span class="s1">&#39;dbname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</code></pre></div>
<p><strong>RDS Proxy with IAM Authentication</strong> (no password needed):</p>
<div class="highlight"><pre><span></span><code><span class="n">rds_proxy</span> <span class="o">=</span> <span class="n">rds</span><span class="o">.</span><span class="n">DatabaseProxy</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;RDSProxy&quot;</span><span class="p">,</span>
    <span class="n">proxy_target</span><span class="o">=</span><span class="n">rds</span><span class="o">.</span><span class="n">ProxyTarget</span><span class="o">.</span><span class="n">from_cluster</span><span class="p">(</span><span class="n">db_cluster</span><span class="p">),</span>
    <span class="n">secrets</span><span class="o">=</span><span class="p">[</span><span class="n">db_secret</span><span class="p">],</span>
    <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
    <span class="n">require_tls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Enforce TLS encryption</span>
    <span class="n">iam_auth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>     <span class="c1"># IAM database authentication</span>
<span class="p">)</span>

<span class="c1"># Lambda connects via IAM (no password in environment)</span>
<span class="n">rds_proxy</span><span class="o">.</span><span class="n">grant_connect</span><span class="p">(</span><span class="n">snapshot_function</span><span class="p">,</span> <span class="s2">&quot;bixarena_user&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="4-audit-logging-monitoring">4. Audit Logging &amp; Monitoring<a class="headerlink" href="#4-audit-logging-monitoring" title="Permanent link">&para;</a></h4>
<p><strong>Structured Logging with Metadata</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
    <span class="s2">&quot;Snapshot generation started&quot;</span><span class="p">,</span>
    <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;trigger_source&quot;</span><span class="p">:</span> <span class="n">trigger_source</span><span class="p">,</span>       <span class="c1"># scheduled or api</span>
        <span class="s2">&quot;triggered_by&quot;</span><span class="p">:</span> <span class="n">triggered_by</span><span class="p">,</span>           <span class="c1"># user email or &quot;system&quot;</span>
        <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>       <span class="c1"># unique trace ID</span>
        <span class="s2">&quot;leaderboard_id&quot;</span><span class="p">:</span> <span class="n">leaderboard_id</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>CloudWatch Alarms</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Alert on Lambda errors</span>
<span class="n">error_alarm</span> <span class="o">=</span> <span class="n">cloudwatch</span><span class="o">.</span><span class="n">Alarm</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="s2">&quot;SnapshotErrorAlarm&quot;</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="n">snapshot_function</span><span class="o">.</span><span class="n">metric_errors</span><span class="p">(),</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">evaluation_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">alarm_description</span><span class="o">=</span><span class="s2">&quot;Leaderboard snapshot generation failed&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">error_alarm</span><span class="o">.</span><span class="n">add_alarm_action</span><span class="p">(</span><span class="n">cloudwatch_actions</span><span class="o">.</span><span class="n">SnsAction</span><span class="p">(</span><span class="n">alert_topic</span><span class="p">))</span>
</code></pre></div>
<h3 id="security-checklist">Security Checklist<a class="headerlink" href="#security-checklist" title="Permanent link">&para;</a></h3>
<ul>
<li>‚úÖ <strong>IAM</strong>: Least privilege roles for Lambda and ECS tasks</li>
<li>‚úÖ <strong>Secrets</strong>: Database credentials in Secrets Manager (or IAM auth)</li>
<li>‚úÖ <strong>Network</strong>: Lambda in private VPC subnet with security groups</li>
<li>‚úÖ <strong>Input Validation</strong>: Whitelist allowed values, validate types and ranges</li>
<li>‚úÖ <strong>Authentication</strong>: API endpoint requires JWT with admin role</li>
<li>‚úÖ <strong>Authorization</strong>: ECS task role scoped to invoke only this Lambda</li>
<li>‚úÖ <strong>Audit Logging</strong>: CloudWatch logs with trigger_source, triggered_by, correlation_id</li>
<li>‚úÖ <strong>Monitoring</strong>: CloudWatch alarms on Lambda errors</li>
<li>‚úÖ <strong>Encryption</strong>: TLS for RDS connection, encrypted secrets at rest</li>
<li>‚úÖ <strong>Rate Limiting</strong>: API Gateway throttling prevents abuse</li>
</ul>
<hr />
<h2 id="part-1-lambda-function-packaging-options">Part 1: Lambda Function Packaging Options<a class="headerlink" href="#part-1-lambda-function-packaging-options" title="Permanent link">&para;</a></h2>
<h3 id="option-a-container-image-docker-recommended">Option A: Container Image (Docker) ‚≠ê <strong>RECOMMENDED</strong><a class="headerlink" href="#option-a-container-image-docker-recommended" title="Permanent link">&para;</a></h3>
<p><strong>Packaging Approach:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c"># Lambda Dockerfile</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">public.ecr.aws/lambda/python:3.13</span>

<span class="c"># Copy shared snapshot logic</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>build<span class="w"> </span>/bixarena_snapshot_lib<span class="w"> </span>/var/task/

<span class="c"># Copy Lambda handler</span>
<span class="k">COPY</span><span class="w"> </span>lambda_function.py<span class="w"> </span>/var/task/

<span class="c"># Set handler</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;lambda_function.handler&quot;</span><span class="p">]</span>
</code></pre></div>
<p><strong>Pros:</strong></p>
<ul>
<li>‚úÖ <strong>Full dependency control</strong>: No 250MB deployment package limit</li>
<li>‚úÖ <strong>Native dependencies</strong>: NumPy, SciPy compile correctly</li>
<li>‚úÖ <strong>Familiar tooling</strong>: Same Docker workflow as other services</li>
<li>‚úÖ <strong>Testing</strong>: Run locally with <code>docker run</code> or SAM CLI</li>
<li>‚úÖ <strong>Reusability</strong>: Base image can be shared across multiple Lambdas</li>
<li>‚úÖ <strong>No layer management</strong>: Everything bundled in one artifact</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>‚ö†Ô∏è <strong>Cold start</strong>: ~2-3 seconds (vs. ~500ms for zip)</li>
<li>‚ö†Ô∏è <strong>Image size</strong>: Up to 10GB (vs. 250MB for zip)</li>
<li>‚ö†Ô∏è <strong>Build complexity</strong>: Requires Docker build in CI/CD</li>
<li>‚ö†Ô∏è <strong>ECR dependency</strong>: Must push to ECR before deployment</li>
</ul>
<p><strong>When to Use:</strong></p>
<ul>
<li>Heavy dependencies (NumPy, SciPy, pandas)</li>
<li>Need native libraries (psycopg binary mode)</li>
<li>Long-running tasks (snapshot generation takes &gt;30 seconds)</li>
<li>Complex build requirements</li>
</ul>
<hr />
<h3 id="option-b-zip-archive-with-lambda-layers">Option B: Zip Archive with Lambda Layers<a class="headerlink" href="#option-b-zip-archive-with-lambda-layers" title="Permanent link">&para;</a></h3>
<p><strong>Packaging Approach:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># CDK code</span>
<span class="n">lambda_function</span> <span class="o">=</span> <span class="n">aws_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;LeaderboardSnapshotFunction&quot;</span><span class="p">,</span>
    <span class="n">runtime</span><span class="o">=</span><span class="n">aws_lambda</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">PYTHON_3_13</span><span class="p">,</span>
    <span class="n">code</span><span class="o">=</span><span class="n">aws_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span>
        <span class="s2">&quot;../../tools/lambda&quot;</span><span class="p">,</span>
        <span class="n">bundling</span><span class="o">=</span><span class="n">BundlingOptions</span><span class="p">(</span>
            <span class="n">image</span><span class="o">=</span><span class="n">Runtime</span><span class="o">.</span><span class="n">PYTHON_3_13</span><span class="o">.</span><span class="n">bundling_image</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pip&quot;</span><span class="p">,</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;requirements.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;/asset-output&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">numpy_scipy_layer</span><span class="p">]</span>  <span class="c1"># Pre-built layer for heavy deps</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>Pros:</strong></p>
<ul>
<li>‚úÖ <strong>Fast cold start</strong>: ~500ms with layers</li>
<li>‚úÖ <strong>Simpler deployment</strong>: No Docker registry needed</li>
<li>‚úÖ <strong>CDK bundling</strong>: Automatic packaging via CDK</li>
<li>‚úÖ <strong>Layer caching</strong>: Heavy deps (NumPy/SciPy) cached across functions</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>‚ö†Ô∏è <strong>Size limits</strong>: 250MB unzipped (50MB zipped)</li>
<li>‚ö†Ô∏è <strong>Dependency conflicts</strong>: Layer versions must match</li>
<li>‚ö†Ô∏è <strong>Complex bundling</strong>: pip install with --platform linux_x86_64</li>
<li>‚ö†Ô∏è <strong>Layer management</strong>: Separate updates for dependencies</li>
</ul>
<p><strong>When to Use:</strong></p>
<ul>
<li>Simple dependencies</li>
<li>Small codebase</li>
<li>Prioritize cold start performance</li>
<li>No native compilation requirements</li>
</ul>
<hr />
<h3 id="option-c-zip-with-inline-bundling-no-layers">Option C: Zip with Inline Bundling (No Layers)<a class="headerlink" href="#option-c-zip-with-inline-bundling-no-layers" title="Permanent link">&para;</a></h3>
<p><strong>Packaging Approach:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># CDK with asset bundling</span>
<span class="n">lambda_function</span> <span class="o">=</span> <span class="n">aws_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;LeaderboardSnapshotFunction&quot;</span><span class="p">,</span>
    <span class="n">runtime</span><span class="o">=</span><span class="n">aws_lambda</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">PYTHON_3_13</span><span class="p">,</span>
    <span class="n">code</span><span class="o">=</span><span class="n">aws_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span>
        <span class="s2">&quot;../../tools/dist/lambda.zip&quot;</span>  <span class="c1"># Pre-built by nx</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>Pros:</strong></p>
<ul>
<li>‚úÖ <strong>Simplest approach</strong>: One zip file, no layers</li>
<li>‚úÖ <strong>Self-contained</strong>: All dependencies included</li>
<li>‚úÖ <strong>No layer versioning</strong>: Everything updates together</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>‚ö†Ô∏è <strong>Every deployment</strong>: Re-uploads all dependencies</li>
<li>‚ö†Ô∏è <strong>Size limits</strong>: Still 250MB unzipped</li>
<li>‚ö†Ô∏è <strong>Slow deployment</strong>: Larger package = longer upload</li>
</ul>
<p><strong>When to Use:</strong></p>
<ul>
<li>Proof of concept</li>
<li>Very small dependencies</li>
<li>Infrequent updates</li>
</ul>
<hr />
<h2 id="recommendation-option-a-container-image">Recommendation: <strong>Option A - Container Image</strong><a class="headerlink" href="#recommendation-option-a-container-image" title="Permanent link">&para;</a></h2>
<p><strong>Rationale:</strong></p>
<ol>
<li><strong>Your dependencies require it</strong>: <code>numpy</code>, <code>scipy</code>, <code>psycopg[binary]</code> are heavy (~150MB)</li>
<li><strong>Consistent with existing workflow</strong>: Already using Docker for all services</li>
<li><strong>Future-proof</strong>: Easy to add more analysis libraries</li>
<li><strong>Testing</strong>: Can run locally with same image</li>
<li><strong>Build pipeline</strong>: Already have Docker build expertise</li>
</ol>
<p><strong>Estimated sizes:</strong></p>
<ul>
<li>Base Python 3.13 Lambda image: ~500MB</li>
<li>
<ul>
<li>NumPy, SciPy: ~150MB</li>
</ul>
</li>
<li>
<ul>
<li>psycopg: ~20MB</li>
</ul>
</li>
<li>
<ul>
<li>Your code: ~5MB</li>
</ul>
</li>
<li><strong>Total</strong>: ~675MB (well under 10GB limit)</li>
</ul>
<hr />
<h2 id="part-2-detailed-implementation-plan">Part 2: Detailed Implementation Plan<a class="headerlink" href="#part-2-detailed-implementation-plan" title="Permanent link">&para;</a></h2>
<h3 id="phase-1-extract-shared-logic-library">Phase 1: Extract Shared Logic Library<a class="headerlink" href="#phase-1-extract-shared-logic-library" title="Permanent link">&para;</a></h3>
<p><strong>Goal</strong>: Create reusable library for leaderboard snapshot generation logic</p>
<h4 id="11-motivation">1.1 Motivation<a class="headerlink" href="#11-motivation" title="Permanent link">&para;</a></h4>
<p>The current implementation in <code>apps/bixarena/tools/</code> contains business logic (Bradley-Terry ranking, snapshot generation) mixed with CLI tooling. Following monorepo best practices:</p>
<p><strong>Current state (anti-pattern):</strong></p>
<div class="highlight"><pre><span></span><code>apps/bixarena/tools/          # App containing business logic ‚ùå
‚îî‚îÄ‚îÄ bixarena_tools/
    ‚îî‚îÄ‚îÄ leaderboard/
        ‚îú‚îÄ‚îÄ db_helper.py      # Database queries (business logic)
        ‚îú‚îÄ‚îÄ rank_battle.py    # Bradley-Terry algorithm (business logic)
        ‚îî‚îÄ‚îÄ leaderboard.py    # CLI + business logic mixed
</code></pre></div>
<p><strong>Problems:</strong></p>
<ul>
<li>‚ùå Apps cannot depend on other apps (violates monorepo rules)</li>
<li>‚ùå Business logic trapped in CLI tool, not reusable</li>
<li>‚ùå Lambda and AI service cannot share code</li>
<li>‚ùå Testing requires running CLI interface</li>
</ul>
<p><strong>Target state (following conventions):</strong></p>
<div class="highlight"><pre><span></span><code>libs/bixarena/leaderboard/    # Library with business logic ‚úÖ
‚îî‚îÄ‚îÄ python/
    ‚îî‚îÄ‚îÄ bixarena_leaderboard/
        ‚îú‚îÄ‚îÄ snapshot.py       # Snapshot generation (business logic)
        ‚îú‚îÄ‚îÄ ranking.py        # Bradley-Terry algorithm (business logic)
        ‚îî‚îÄ‚îÄ database.py       # Database queries (business logic)

apps/bixarena/tools/          # App consuming library ‚úÖ
‚îî‚îÄ‚îÄ bixarena_tools/
    ‚îî‚îÄ‚îÄ leaderboard/
        ‚îî‚îÄ‚îÄ leaderboard.py    # CLI interface only (depends on lib)
</code></pre></div>
<p><strong>Benefits:</strong></p>
<ul>
<li>‚úÖ Libraries can be consumed by both apps and other libs</li>
<li>‚úÖ Business logic is reusable, testable, and versioned independently</li>
<li>‚úÖ Apps remain thin (UI/CLI/API only)</li>
<li>‚úÖ Clear separation of concerns</li>
</ul>
<h4 id="12-create-domain-specific-library-package">1.2 Create Domain-Specific Library Package<a class="headerlink" href="#12-create-domain-specific-library-package" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: <code>libs/bixarena/leaderboard/python/</code></p>
<p><strong>Naming conventions:</strong></p>
<ul>
<li><strong>Nx project name</strong>: <code>bixarena-leaderboard-python</code> (matches folder path per naming rule)</li>
<li><strong>Python/uv project name</strong>: <code>bixarena-leaderboard</code> (no "python" suffix in Python ecosystem)</li>
<li><strong>Package name</strong>: <code>bixarena_leaderboard</code> (Python import name)</li>
</ul>
<p><strong>Structure:</strong></p>
<div class="highlight"><pre><span></span><code>libs/bixarena/leaderboard/python/
‚îú‚îÄ‚îÄ pyproject.toml                    # Python package definition
‚îú‚îÄ‚îÄ project.json                      # Nx project configuration
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ bixarena_leaderboard/             # Package (importable code)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ snapshot.py                   # SnapshotGenerator, SnapshotConfig
‚îÇ   ‚îú‚îÄ‚îÄ database.py                   # DB queries (from db_helper.py)
‚îÇ   ‚îú‚îÄ‚îÄ ranking.py                    # Bradley-Terry (from rank_battle.py)
‚îÇ   ‚îî‚îÄ‚îÄ config.py                     # Configuration dataclasses
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ test_snapshot.py
    ‚îú‚îÄ‚îÄ test_ranking.py
    ‚îî‚îÄ‚îÄ test_database.py
</code></pre></div>
<p><strong>Core API:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># bixarena_leaderboard/snapshot.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SnapshotConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for snapshot generation.&quot;&quot;&quot;</span>
    <span class="n">database_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">leaderboard_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;overall&quot;</span>
    <span class="n">num_bootstrap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">min_evaluations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rank_by_significance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SnapshotGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate leaderboard snapshots from battle evaluations.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SnapshotConfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_publish</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a new snapshot and save to database.</span>

<span class="sd">        Args:</span>
<span class="sd">            auto_publish: If True, set snapshot visibility to public immediately</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict with snapshot_id, entry_count, evaluation_count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract from existing leaderboard.py:snapshot_add()</span>
        <span class="c1"># 1. Fetch data from DB</span>
        <span class="c1"># 2. Compute Bradley-Terry rankings</span>
        <span class="c1"># 3. Insert snapshot and entries</span>
        <span class="c1"># 4. Set visibility=True if auto_publish=True</span>
        <span class="c1"># 5. Return metadata</span>
        <span class="k">pass</span>
</code></pre></div>
<p><strong>pyproject.toml:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">[project]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;bixarena-leaderboard&quot;</span><span class="w">  </span><span class="c1"># No &quot;python&quot; suffix in Python ecosystem</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span>
<span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;BixArena leaderboard snapshot generation and ranking algorithms&quot;</span>
<span class="n">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;==3.13.3&quot;</span>
<span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;numpy&gt;=1.26.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;psycopg[binary]&gt;=3.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;scipy&gt;=1.11.0&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">[tool.hatch.build.targets.wheel]</span>
<span class="n">packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;bixarena_leaderboard&quot;</span><span class="p">]</span>

<span class="k">[build-system]</span>
<span class="n">requires</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;hatchling&quot;</span><span class="p">]</span>
<span class="n">build-backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hatchling.build&quot;</span>
</code></pre></div>
<p><strong>project.json (Nx configuration):</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bixarena-leaderboard-python&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;$schema&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;../../../../node_modules/nx/schemas/project-schema.json&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;sourceRoot&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;libs/bixarena/leaderboard/python/bixarena_leaderboard&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;projectType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;library&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;executor&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;@nxlv/python:build&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;outputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;{projectRoot}/dist&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;outputPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{projectRoot}/dist&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;publish&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;lockedVersions&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;bundleLocalDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;executor&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;@nxlv/python:run-commands&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;outputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;uv run pytest tests/&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{projectRoot}&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;type:library&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;scope:backend&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;language:python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;domain:leaderboard&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="13-migrate-existing-code">1.3 Migrate Existing Code<a class="headerlink" href="#13-migrate-existing-code" title="Permanent link">&para;</a></h4>
<p><strong>Move from</strong> <code>apps/bixarena/tools/bixarena_tools/leaderboard/</code>:</p>
<ul>
<li>‚úÖ <code>db_helper.py</code> ‚Üí <code>libs/bixarena/leaderboard/python/bixarena_leaderboard/database.py</code></li>
<li>‚úÖ <code>rank_battle.py</code> ‚Üí <code>libs/bixarena/leaderboard/python/bixarena_leaderboard/ranking.py</code></li>
<li>‚úÖ Core logic from <code>leaderboard.py:snapshot_add()</code> ‚Üí <code>bixarena_leaderboard/snapshot.py</code></li>
</ul>
<p><strong>Keep in tools package</strong> (CLI becomes thin wrapper):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># apps/bixarena/tools/bixarena_tools/leaderboard/leaderboard.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bixarena_leaderboard</span><span class="w"> </span><span class="kn">import</span> <span class="n">SnapshotGenerator</span><span class="p">,</span> <span class="n">SnapshotConfig</span>  <span class="c1"># Import from lib</span>

<span class="nd">@snapshot_app</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">snapshot_add</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new leaderboard snapshot.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_db_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="c1"># Database connection still managed by CLI tool</span>
        <span class="n">database_url</span> <span class="o">=</span> <span class="n">build_database_url</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

        <span class="c1"># Use library for business logic</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">SnapshotConfig</span><span class="p">(</span>
            <span class="n">database_url</span><span class="o">=</span><span class="n">database_url</span><span class="p">,</span>
            <span class="n">leaderboard_id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">num_bootstrap</span><span class="o">=</span><span class="n">num_bootstrap</span><span class="p">,</span>
            <span class="n">min_evaluations</span><span class="o">=</span><span class="n">min_evals</span><span class="p">,</span>
            <span class="n">rank_by_significance</span><span class="o">=</span><span class="n">significant</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="n">SnapshotGenerator</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_snapshot</span><span class="p">(</span><span class="n">auto_publish</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># CLI-specific display logic</span>
        <span class="n">display_leaderboard_summary</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p><strong>Update tools pyproject.toml:</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="c1"># ... existing deps ...</span>
<span class="w">    </span><span class="s2">&quot;bixarena-leaderboard&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># New dependency on lib</span>
<span class="p">]</span>

<span class="k">[tool.uv.sources]</span>
<span class="n">bixarena-leaderboard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">workspace</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="phase-2-lambda-function-implementation">Phase 2: Lambda Function Implementation<a class="headerlink" href="#phase-2-lambda-function-implementation" title="Permanent link">&para;</a></h3>
<h4 id="21-lambda-handler-code">2.1 Lambda Handler Code<a class="headerlink" href="#21-lambda-handler-code" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>apps/bixarena/functions/leaderboard-snapshot/
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ lambda_function.py
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ README.md
</code></pre></div>
<p><strong>lambda_function.py:</strong></p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Lambda handler for scheduled leaderboard snapshot generation.&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">UTC</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">bixarena_leaderboard</span><span class="w"> </span><span class="kn">import</span> <span class="n">SnapshotConfig</span><span class="p">,</span> <span class="n">SnapshotGenerator</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">sns_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sns&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">validate_inputs</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate and sanitize Lambda event inputs.&quot;&quot;&quot;</span>
    <span class="c1"># Whitelist allowed leaderboards</span>
    <span class="n">allowed_leaderboards</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">,</span> <span class="s2">&quot;open-source&quot;</span><span class="p">,</span> <span class="s2">&quot;multimodal&quot;</span><span class="p">]</span>
    <span class="n">leaderboard_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;leaderboard_id&quot;</span><span class="p">,</span> <span class="s2">&quot;overall&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leaderboard_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_leaderboards</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid leaderboard_id: </span><span class="si">{</span><span class="n">leaderboard_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validate bootstrap iterations (reasonable range)</span>
    <span class="n">num_bootstrap</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_bootstrap&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_bootstrap</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">num_bootstrap</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">or</span> <span class="n">num_bootstrap</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid num_bootstrap: </span><span class="si">{</span><span class="n">num_bootstrap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validate trigger source</span>
    <span class="n">trigger_source</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trigger_source&quot;</span><span class="p">,</span> <span class="s2">&quot;scheduled&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trigger_source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;scheduled&quot;</span><span class="p">,</span> <span class="s2">&quot;api&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid trigger_source: </span><span class="si">{</span><span class="n">trigger_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_database_url</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve database credentials from Secrets Manager.&quot;&quot;&quot;</span>
    <span class="n">secret_arn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DB_SECRET_ARN&quot;</span><span class="p">]</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;secretsmanager&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_secret_value</span><span class="p">(</span><span class="n">SecretId</span><span class="o">=</span><span class="n">secret_arn</span><span class="p">)</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;SecretString&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;postgresql://</span><span class="si">{</span><span class="n">secret</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">secret</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">secret</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">secret</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">secret</span><span class="p">[</span><span class="s1">&#39;dbname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lambda entry point for snapshot generation.</span>

<span class="sd">    Args:</span>
<span class="sd">        event: Event payload with metadata</span>
<span class="sd">            - trigger_source: &quot;scheduled&quot; or &quot;api&quot;</span>
<span class="sd">            - triggered_by: User email (for API) or &quot;system&quot; (for scheduled)</span>
<span class="sd">            - correlation_id: Unique trace ID</span>
<span class="sd">            - leaderboard_id: Leaderboard to generate</span>
<span class="sd">            - num_bootstrap: Bootstrap iterations</span>
<span class="sd">        context: Lambda context object</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response with snapshot metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Extract metadata</span>
    <span class="n">trigger_source</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trigger_source&quot;</span><span class="p">,</span> <span class="s2">&quot;scheduled&quot;</span><span class="p">)</span>
    <span class="n">triggered_by</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;triggered_by&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">)</span>
    <span class="n">correlation_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correlation_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
    <span class="n">leaderboard_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;leaderboard_id&quot;</span><span class="p">,</span> <span class="s2">&quot;overall&quot;</span><span class="p">)</span>
    <span class="n">num_bootstrap</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_bootstrap&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Validate inputs</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">validate_inputs</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input validation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span>
        <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Snapshot generation started&quot;</span><span class="p">,</span>
        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;trigger_source&quot;</span><span class="p">:</span> <span class="n">trigger_source</span><span class="p">,</span>
            <span class="s2">&quot;triggered_by&quot;</span><span class="p">:</span> <span class="n">triggered_by</span><span class="p">,</span>
            <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
            <span class="s2">&quot;leaderboard_id&quot;</span><span class="p">:</span> <span class="n">leaderboard_id</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Get database URL from Secrets Manager</span>
    <span class="n">database_url</span> <span class="o">=</span> <span class="n">get_database_url</span><span class="p">()</span>

    <span class="c1"># Configuration</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">SnapshotConfig</span><span class="p">(</span>
        <span class="n">database_url</span><span class="o">=</span><span class="n">database_url</span><span class="p">,</span>
        <span class="n">leaderboard_id</span><span class="o">=</span><span class="n">leaderboard_id</span><span class="p">,</span>
        <span class="n">num_bootstrap</span><span class="o">=</span><span class="n">num_bootstrap</span><span class="p">,</span>
        <span class="n">min_evaluations</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MIN_EVALUATIONS&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)),</span>
        <span class="n">rank_by_significance</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RANK_BY_SIGNIFICANCE&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">SnapshotGenerator</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_snapshot</span><span class="p">(</span><span class="n">auto_publish</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

        <span class="c1"># Publish success notification to SNS</span>
        <span class="n">topic_arn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NOTIFICATION_TOPIC_ARN&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">topic_arn</span><span class="p">:</span>
            <span class="n">sns_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="n">TopicArn</span><span class="o">=</span><span class="n">topic_arn</span><span class="p">,</span>
                <span class="n">Subject</span><span class="o">=</span><span class="s2">&quot;Leaderboard Snapshot Generated&quot;</span><span class="p">,</span>
                <span class="n">Message</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;trigger_source&quot;</span><span class="p">:</span> <span class="n">trigger_source</span><span class="p">,</span>
                    <span class="s2">&quot;triggered_by&quot;</span><span class="p">:</span> <span class="n">triggered_by</span><span class="p">,</span>
                    <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
                    <span class="s2">&quot;leaderboard_id&quot;</span><span class="p">:</span> <span class="n">leaderboard_id</span><span class="p">,</span>
                    <span class="s2">&quot;snapshot_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;snapshot_id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;entry_count&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;entry_count&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;evaluation_count&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;evaluation_count&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;duration_seconds&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="p">}),</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Snapshot created successfully: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
                <span class="s2">&quot;snapshot_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;snapshot_id&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Snapshot generated successfully&quot;</span><span class="p">,</span>
                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
                <span class="s2">&quot;snapshot_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;snapshot_id&quot;</span><span class="p">],</span>
                <span class="s2">&quot;entry_count&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;entry_count&quot;</span><span class="p">],</span>
                <span class="s2">&quot;evaluation_count&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;evaluation_count&quot;</span><span class="p">],</span>
                <span class="s2">&quot;duration_seconds&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
            <span class="p">}),</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

        <span class="c1"># Publish failure notification to SNS</span>
        <span class="n">topic_arn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NOTIFICATION_TOPIC_ARN&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">topic_arn</span><span class="p">:</span>
            <span class="n">sns_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="n">TopicArn</span><span class="o">=</span><span class="n">topic_arn</span><span class="p">,</span>
                <span class="n">Subject</span><span class="o">=</span><span class="s2">&quot;Leaderboard Snapshot Failed&quot;</span><span class="p">,</span>
                <span class="n">Message</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failure&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;trigger_source&quot;</span><span class="p">:</span> <span class="n">trigger_source</span><span class="p">,</span>
                    <span class="s2">&quot;triggered_by&quot;</span><span class="p">:</span> <span class="n">triggered_by</span><span class="p">,</span>
                    <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
                    <span class="s2">&quot;leaderboard_id&quot;</span><span class="p">:</span> <span class="n">leaderboard_id</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;duration_seconds&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="p">}),</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to generate snapshot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
                <span class="s2">&quot;trigger_source&quot;</span><span class="p">:</span> <span class="n">trigger_source</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Snapshot generation failed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="p">}),</span>
        <span class="p">}</span>
</code></pre></div>
<p><strong>Dockerfile:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="s">public.ecr.aws/lambda/python:3.13</span>

<span class="c"># Install system dependencies (if needed for psycopg)</span>
<span class="k">RUN</span><span class="w"> </span>microdnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>gcc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>postgresql-devel<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>microdnf<span class="w"> </span>clean<span class="w"> </span>all

<span class="c"># Copy leaderboard library from workspace</span>
<span class="k">COPY</span><span class="w"> </span>../../../libs/bixarena/leaderboard/python<span class="w"> </span>/tmp/bixarena-leaderboard
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>/tmp/bixarena-leaderboard<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/tmp/bixarena-leaderboard

<span class="c"># Copy Lambda function</span>
<span class="k">COPY</span><span class="w"> </span>lambda_function.py<span class="w"> </span><span class="si">${</span><span class="nv">LAMBDA_TASK_ROOT</span><span class="si">}</span>/
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span><span class="si">${</span><span class="nv">LAMBDA_TASK_ROOT</span><span class="si">}</span>/

<span class="c"># Install Lambda-specific dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span><span class="si">${</span><span class="nv">LAMBDA_TASK_ROOT</span><span class="si">}</span>/requirements.txt<span class="w"> </span>--target<span class="w"> </span><span class="si">${</span><span class="nv">LAMBDA_TASK_ROOT</span><span class="si">}</span>

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;lambda_function.handler&quot;</span><span class="p">]</span>
</code></pre></div>
<p><strong>requirements.txt:</strong></p>
<div class="highlight"><pre><span></span><code># Leaderboard library will be installed separately (from workspace)
# Add any Lambda-specific dependencies here
boto3&gt;=1.40.0  # AWS SDK (included in Lambda runtime, but pin version)
</code></pre></div>
<h4 id="22-cdk-stack-implementation">2.2 CDK Stack Implementation<a class="headerlink" href="#22-cdk-stack-implementation" title="Permanent link">&para;</a></h4>
<p><strong>File</strong>: <code>apps/bixarena/infra/cdk/bixarena_infra_cdk/shared/stacks/leaderboard_snapshot_stack.py</code></p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;CDK stack for leaderboard snapshot automation.&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aws_cdk</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Duration</span><span class="p">,</span>
    <span class="n">Stack</span><span class="p">,</span>
    <span class="n">aws_ec2</span> <span class="k">as</span> <span class="n">ec2</span><span class="p">,</span>
    <span class="n">aws_ecr_assets</span> <span class="k">as</span> <span class="n">ecr_assets</span><span class="p">,</span>
    <span class="n">aws_events</span> <span class="k">as</span> <span class="n">events</span><span class="p">,</span>
    <span class="n">aws_events_targets</span> <span class="k">as</span> <span class="n">targets</span><span class="p">,</span>
    <span class="n">aws_iam</span> <span class="k">as</span> <span class="n">iam</span><span class="p">,</span>
    <span class="n">aws_lambda</span> <span class="k">as</span> <span class="n">lambda_</span><span class="p">,</span>
    <span class="n">aws_logs</span> <span class="k">as</span> <span class="n">logs</span><span class="p">,</span>
    <span class="n">aws_rds</span> <span class="k">as</span> <span class="n">rds</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">constructs</span><span class="w"> </span><span class="kn">import</span> <span class="n">Construct</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LeaderboardSnapshotStack</span><span class="p">(</span><span class="n">Stack</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stack for automated leaderboard snapshot generation.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">scope</span><span class="p">:</span> <span class="n">Construct</span><span class="p">,</span>
        <span class="n">construct_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">vpc</span><span class="p">:</span> <span class="n">ec2</span><span class="o">.</span><span class="n">IVpc</span><span class="p">,</span>
        <span class="n">database_instance</span><span class="p">:</span> <span class="n">rds</span><span class="o">.</span><span class="n">IDatabaseInstance</span><span class="p">,</span>
        <span class="n">database_secret_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">environment_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">construct_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Build and push Docker image to ECR</span>
        <span class="n">lambda_image</span> <span class="o">=</span> <span class="n">ecr_assets</span><span class="o">.</span><span class="n">DockerImageAsset</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;LeaderboardSnapshotImage&quot;</span><span class="p">,</span>
            <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;../../functions/leaderboard-snapshot&quot;</span><span class="p">,</span>
            <span class="n">platform</span><span class="o">=</span><span class="n">ecr_assets</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">LINUX_AMD64</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Lambda function</span>
        <span class="n">snapshot_function</span> <span class="o">=</span> <span class="n">lambda_</span><span class="o">.</span><span class="n">DockerImageFunction</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;LeaderboardSnapshotFunction&quot;</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">lambda_</span><span class="o">.</span><span class="n">DockerImageCode</span><span class="o">.</span><span class="n">from_ecr</span><span class="p">(</span>
                <span class="n">repository</span><span class="o">=</span><span class="n">lambda_image</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span>
                <span class="n">tag</span><span class="o">=</span><span class="n">lambda_image</span><span class="o">.</span><span class="n">asset_hash</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">Duration</span><span class="o">.</span><span class="n">minutes</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>  <span class="c1"># Max Lambda timeout</span>
            <span class="n">memory_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>  <span class="c1"># 2GB for NumPy/SciPy</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="n">vpc_subnets</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetSelection</span><span class="p">(</span>
                <span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PRIVATE_WITH_EGRESS</span>
            <span class="p">),</span>
            <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;DATABASE_URL&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;postgresql://</span><span class="se">{{</span><span class="s2">username</span><span class="se">}}</span><span class="s2">:</span><span class="se">{{</span><span class="s2">password</span><span class="se">}}</span><span class="s2">@</span><span class="si">{</span><span class="n">database_instance</span><span class="o">.</span><span class="n">db_instance_endpoint_address</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">database_instance</span><span class="o">.</span><span class="n">db_instance_endpoint_port</span><span class="si">}</span><span class="s2">/bixarena&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LEADERBOARD_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;overall&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_BOOTSTRAP&quot;</span><span class="p">:</span> <span class="s2">&quot;1000&quot;</span><span class="p">,</span>  <span class="c1"># Production uses more iterations</span>
                <span class="s2">&quot;MIN_EVALUATIONS&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;RANK_BY_SIGNIFICANCE&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LOG_LEVEL&quot;</span><span class="p">:</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">log_retention</span><span class="o">=</span><span class="n">logs</span><span class="o">.</span><span class="n">RetentionDays</span><span class="o">.</span><span class="n">ONE_MONTH</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Generate daily leaderboard snapshots for </span><span class="si">{</span><span class="n">environment_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Grant database access</span>
        <span class="n">database_instance</span><span class="o">.</span><span class="n">grant_connect</span><span class="p">(</span><span class="n">snapshot_function</span><span class="p">)</span>

        <span class="c1"># Grant access to read database credentials from Secrets Manager</span>
        <span class="n">snapshot_function</span><span class="o">.</span><span class="n">add_to_role_policy</span><span class="p">(</span>
            <span class="n">iam</span><span class="o">.</span><span class="n">PolicyStatement</span><span class="p">(</span>
                <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;secretsmanager:GetSecretValue&quot;</span><span class="p">],</span>
                <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">database_secret_arn</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># EventBridge rule - daily at 2 AM UTC</span>
        <span class="n">schedule_rule</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">Rule</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;LeaderboardSnapshotSchedule&quot;</span><span class="p">,</span>
            <span class="n">schedule</span><span class="o">=</span><span class="n">events</span><span class="o">.</span><span class="n">Schedule</span><span class="o">.</span><span class="n">cron</span><span class="p">(</span>
                <span class="n">minute</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                <span class="n">hour</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                <span class="n">month</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                <span class="n">week_day</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                <span class="n">year</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Trigger daily leaderboard snapshot generation&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add Lambda as target</span>
        <span class="n">schedule_rule</span><span class="o">.</span><span class="n">add_target</span><span class="p">(</span>
            <span class="n">targets</span><span class="o">.</span><span class="n">LambdaFunction</span><span class="p">(</span>
                <span class="n">snapshot_function</span><span class="p">,</span>
                <span class="n">retry_attempts</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># CloudWatch Dashboard (optional)</span>
        <span class="c1"># TODO: Add metrics for snapshot generation success/failure</span>

        <span class="c1"># Outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_function</span> <span class="o">=</span> <span class="n">snapshot_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_rule</span> <span class="o">=</span> <span class="n">schedule_rule</span>
</code></pre></div>
<p><strong>Integration in <code>dev/app.py</code>:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">bixarena_infra_cdk.shared.stacks.leaderboard_snapshot_stack</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">LeaderboardSnapshotStack</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># After database_stack is created...</span>
<span class="n">snapshot_stack</span> <span class="o">=</span> <span class="n">LeaderboardSnapshotStack</span><span class="p">(</span>
    <span class="n">app</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;BixarenaSnapshotStack-</span><span class="si">{</span><span class="n">env_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">vpc</span><span class="o">=</span><span class="n">vpc_stack</span><span class="o">.</span><span class="n">vpc</span><span class="p">,</span>
    <span class="n">database_instance</span><span class="o">=</span><span class="n">database_stack</span><span class="o">.</span><span class="n">database_instance</span><span class="p">,</span>
    <span class="n">database_secret_arn</span><span class="o">=</span><span class="n">database_stack</span><span class="o">.</span><span class="n">database_secret</span><span class="o">.</span><span class="n">secret_arn</span><span class="p">,</span>
    <span class="n">environment_name</span><span class="o">=</span><span class="n">env_name</span><span class="p">,</span>
    <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">snapshot_stack</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">database_stack</span><span class="p">)</span>
<span class="n">snapshot_stack</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">vpc_stack</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="phase-3-ai-service-endpoint-implementation">Phase 3: AI Service Endpoint Implementation<a class="headerlink" href="#phase-3-ai-service-endpoint-implementation" title="Permanent link">&para;</a></h3>
<h4 id="31-add-admin-endpoint">3.1 Add Admin Endpoint<a class="headerlink" href="#31-add-admin-endpoint" title="Permanent link">&para;</a></h4>
<p><strong>File</strong>: <code>apps/bixarena/ai-service/bixarena_ai_service/jobs/__init__.py</code></p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Background jobs and admin operations.&quot;&quot;&quot;</span>
</code></pre></div>
<p><strong>File</strong>: <code>apps/bixarena/ai-service/bixarena_ai_service/routers/admin.py</code></p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Admin operations router.&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">bixarena_ai_service.security.jwt_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_jwt</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/admin&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Admin Operations&quot;</span><span class="p">])</span>
<span class="n">lambda_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SnapshotRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request to generate a leaderboard snapshot.&quot;&quot;&quot;</span>

    <span class="n">leaderboard_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;overall&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Leaderboard ID to generate snapshot for&quot;</span>
    <span class="p">)</span>
    <span class="n">num_bootstrap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Bootstrap iterations&quot;</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SnapshotResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Response for async snapshot generation.&quot;&quot;&quot;</span>

    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">correlation_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">leaderboard_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;initiated&quot;</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_jwt_admin</span><span class="p">(</span>
    <span class="n">jwt_claims</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">validate_jwt</span><span class="p">)],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate JWT and ensure user has admin role.</span>

<span class="sd">    Returns:</span>
<span class="sd">        User email for audit logging</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If user does not have admin role</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">jwt_claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cognito:groups&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">jwt_claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="n">jwt_claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;admin&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> attempted snapshot generation without admin role&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">roles</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Admin role required for snapshot generation&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">email</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;/generate-snapshot&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">SnapshotResponse</span><span class="p">,</span>
    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_202_ACCEPTED</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Trigger leaderboard snapshot generation&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Asynchronously trigger leaderboard snapshot generation.</span>

<span class="s2">    This endpoint invokes a Lambda function and returns immediately with a correlation ID.</span>
<span class="s2">    The snapshot generation runs in the background (takes 2-5 minutes).</span>
<span class="s2">    You will receive a Slack notification when complete.</span>

<span class="s2">    Requires authentication with admin role.</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_snapshot</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">SnapshotRequest</span><span class="p">,</span>
    <span class="n">user_email</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">validate_jwt_admin</span><span class="p">)],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Trigger asynchronous leaderboard snapshot generation.</span>

<span class="sd">    Args:</span>
<span class="sd">        request: Snapshot generation parameters</span>
<span class="sd">        user_email: Email of authenticated admin user</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response with correlation ID for tracking</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">lambda_function_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SNAPSHOT_LAMBDA_NAME&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">lambda_function_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Snapshot Lambda function not configured&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Snapshot generation triggered by </span><span class="si">{</span><span class="n">user_email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;user_email&quot;</span><span class="p">:</span> <span class="n">user_email</span><span class="p">,</span>
            <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
            <span class="s2">&quot;leaderboard_id&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">leaderboard_id</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Invoke Lambda asynchronously</span>
        <span class="n">lambda_client</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="n">FunctionName</span><span class="o">=</span><span class="n">lambda_function_name</span><span class="p">,</span>
            <span class="n">InvocationType</span><span class="o">=</span><span class="s2">&quot;Event&quot;</span><span class="p">,</span>  <span class="c1"># Async invocation (fire-and-forget)</span>
            <span class="n">Payload</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s2">&quot;trigger_source&quot;</span><span class="p">:</span> <span class="s2">&quot;api&quot;</span><span class="p">,</span>
                <span class="s2">&quot;triggered_by&quot;</span><span class="p">:</span> <span class="n">user_email</span><span class="p">,</span>
                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
                <span class="s2">&quot;leaderboard_id&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">leaderboard_id</span><span class="p">,</span>
                <span class="s2">&quot;num_bootstrap&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">num_bootstrap</span><span class="p">,</span>
            <span class="p">}),</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Lambda invoked successfully for correlation_id </span><span class="si">{</span><span class="n">correlation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">SnapshotResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Snapshot generation initiated. &quot;</span>
                <span class="s2">&quot;You will receive a Slack notification when complete.&quot;</span>
            <span class="p">),</span>
            <span class="n">correlation_id</span><span class="o">=</span><span class="n">correlation_id</span><span class="p">,</span>
            <span class="n">leaderboard_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">leaderboard_id</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;initiated&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="n">lambda_client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to invoke Lambda: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">},</span>
            <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to trigger snapshot generation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div>
<p><strong>Register router in <code>app.py</code>:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">bixarena_ai_service.routers.admin</span><span class="w"> </span><span class="kn">import</span> <span class="n">router</span> <span class="k">as</span> <span class="n">admin_router</span>

<span class="c1"># After middleware setup</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">admin_router</span><span class="p">)</span>
</code></pre></div>
<h4 id="32-update-ai-service-dependencies">3.2 Update AI Service Dependencies<a class="headerlink" href="#32-update-ai-service-dependencies" title="Permanent link">&para;</a></h4>
<p><strong>Add boto3 to <code>pyproject.toml</code>:</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="c1"># ... existing deps ...</span>
<span class="w">    </span><span class="s2">&quot;boto3&gt;=1.40.0&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># AWS SDK for Lambda invocation</span>
<span class="p">]</span>
</code></pre></div>
<p><strong>Add environment variable to AI service:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># In CDK stack for AI service ECS task definition</span>
<span class="n">task_definition</span><span class="o">.</span><span class="n">add_container</span><span class="p">(</span>
    <span class="s2">&quot;AIServiceContainer&quot;</span><span class="p">,</span>
    <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
        <span class="c1"># ... existing env vars ...</span>
        <span class="s2">&quot;SNAPSHOT_LAMBDA_NAME&quot;</span><span class="p">:</span> <span class="n">snapshot_lambda</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c1"># Grant ECS task role permission to invoke Lambda</span>
<span class="n">snapshot_lambda</span><span class="o">.</span><span class="n">grant_invoke</span><span class="p">(</span><span class="n">ai_service_task_role</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="phase-4-database-connection-strategy">Phase 4: Database Connection Strategy<a class="headerlink" href="#phase-4-database-connection-strategy" title="Permanent link">&para;</a></h3>
<h4 id="option-a-rds-proxy-recommended-for-lambda">Option A: RDS Proxy (Recommended for Lambda)<a class="headerlink" href="#option-a-rds-proxy-recommended-for-lambda" title="Permanent link">&para;</a></h4>
<p><strong>Why RDS Proxy:</strong></p>
<ul>
<li>Connection pooling for Lambda (many concurrent invocations)</li>
<li>Automatic failover</li>
<li>IAM authentication (no password in env vars)</li>
<li>Reduced DB connections</li>
</ul>
<p><strong>CDK Implementation:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># In leaderboard_snapshot_stack.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aws_cdk</span><span class="w"> </span><span class="kn">import</span> <span class="n">aws_rds</span> <span class="k">as</span> <span class="n">rds</span>

<span class="c1"># Create RDS Proxy</span>
<span class="n">db_proxy</span> <span class="o">=</span> <span class="n">rds</span><span class="o">.</span><span class="n">DatabaseProxy</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="s2">&quot;LeaderboardDBProxy&quot;</span><span class="p">,</span>
    <span class="n">proxy_target</span><span class="o">=</span><span class="n">rds</span><span class="o">.</span><span class="n">ProxyTarget</span><span class="o">.</span><span class="n">from_instance</span><span class="p">(</span><span class="n">database_instance</span><span class="p">),</span>
    <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
    <span class="n">secrets</span><span class="o">=</span><span class="p">[</span><span class="n">database_secret</span><span class="p">],</span>
    <span class="n">require_tls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Update Lambda environment</span>
<span class="n">snapshot_function</span> <span class="o">=</span> <span class="n">lambda_</span><span class="o">.</span><span class="n">DockerImageFunction</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;DATABASE_URL&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;postgresql://</span><span class="se">{{</span><span class="s2">username</span><span class="se">}}</span><span class="s2">:</span><span class="se">{{</span><span class="s2">password</span><span class="se">}}</span><span class="s2">@</span><span class="si">{</span><span class="n">db_proxy</span><span class="o">.</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">/bixarena&quot;</span><span class="p">,</span>
        <span class="c1"># ...</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c1"># Grant proxy access</span>
<span class="n">db_proxy</span><span class="o">.</span><span class="n">grant_connect</span><span class="p">(</span><span class="n">snapshot_function</span><span class="p">,</span> <span class="s2">&quot;postgres&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="option-b-direct-connection-simpler-for-ai-service">Option B: Direct Connection (Simpler for AI Service)<a class="headerlink" href="#option-b-direct-connection-simpler-for-ai-service" title="Permanent link">&para;</a></h4>
<p><strong>AI Service</strong> can use direct connection (already configured):</p>
<ul>
<li>Long-lived service maintains connection pool</li>
<li>No cold start issues</li>
<li>Simpler configuration</li>
</ul>
<hr />
<h3 id="phase-5-testing-strategy">Phase 5: Testing Strategy<a class="headerlink" href="#phase-5-testing-strategy" title="Permanent link">&para;</a></h3>
<h4 id="51-local-testing">5.1 Local Testing<a class="headerlink" href="#51-local-testing" title="Permanent link">&para;</a></h4>
<p><strong>Test Lambda Locally:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Build Docker image</span>
<span class="nb">cd</span><span class="w"> </span>apps/bixarena/functions/leaderboard-snapshot
docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>leaderboard-snapshot-local<span class="w"> </span>.

<span class="c1"># Run with local PostgreSQL (port forwarded)</span>
docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">9000</span>:8080<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">DATABASE_URL</span><span class="o">=</span><span class="s2">&quot;postgresql://postgres:changeme@host.docker.internal:5432/bixarena&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">LEADERBOARD_ID</span><span class="o">=</span><span class="s2">&quot;overall&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">NUM_BOOTSTRAP</span><span class="o">=</span><span class="s2">&quot;10&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>leaderboard-snapshot-local

<span class="c1"># Invoke</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s2">&quot;http://localhost:9000/2015-03-31/functions/function/invocations&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{}&#39;</span>
</code></pre></div>
<p><strong>Test AI Service Endpoint:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Get session cookie from browser</span>
<span class="nv">SESSION_ID</span><span class="o">=</span><span class="s2">&quot;your-session-id&quot;</span>

<span class="c1"># Call admin endpoint</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s2">&quot;http://localhost:8113/admin/generate-snapshot&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Cookie: JSESSIONID=</span><span class="si">${</span><span class="nv">SESSION_ID</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;leaderboard_id&quot;: &quot;overall&quot;,</span>
<span class="s1">    &quot;num_bootstrap&quot;: 10</span>
<span class="s1">  }&#39;</span>
</code></pre></div>
<h4 id="52-integration-testing">5.2 Integration Testing<a class="headerlink" href="#52-integration-testing" title="Permanent link">&para;</a></h4>
<p><strong>Test in AWS Dev Environment:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Deploy stack</span>
nx<span class="w"> </span>run<span class="w"> </span>bixarena-infra-cdk:deploy:dev<span class="w"> </span>--stacks<span class="o">=</span><span class="s2">&quot;*Snapshot*&quot;</span>

<span class="c1"># Manually invoke Lambda</span>
aws<span class="w"> </span>lambda<span class="w"> </span>invoke<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--function-name<span class="w"> </span>bixarena-dev-<span class="o">{</span>name<span class="o">}</span>-leaderboard-snapshot<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--profile<span class="w"> </span>bixarena-dev-Developer<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>response.json

<span class="c1"># Check logs</span>
aws<span class="w"> </span>logs<span class="w"> </span>tail<span class="w"> </span>/aws/lambda/bixarena-dev-<span class="o">{</span>name<span class="o">}</span>-leaderboard-snapshot<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--follow<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--profile<span class="w"> </span>bixarena-dev-Developer
</code></pre></div>
<hr />
<h2 id="phase-6-deployment-workflow">Phase 6: Deployment Workflow<a class="headerlink" href="#phase-6-deployment-workflow" title="Permanent link">&para;</a></h2>
<h3 id="61-build-pipeline">6.1 Build Pipeline<a class="headerlink" href="#61-build-pipeline" title="Permanent link">&para;</a></h3>
<p><strong>Update <code>project.json</code> in <code>apps/bixarena/functions/leaderboard-snapshot</code>:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;leaderboard-snapshot-function&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;projectType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;application&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;build-image&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;executor&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nx:run-commands&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;docker build -t leaderboard-snapshot:latest .&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{projectRoot}&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;dependsOn&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;^build&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;test-local&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;executor&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nx:run-commands&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;docker run --rm -p 9000:8080 leaderboard-snapshot:latest&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{projectRoot}&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;dependsOn&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;build-image&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;type:function&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;scope:backend&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;language:python&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="62-cicd-integration">6.2 CI/CD Integration<a class="headerlink" href="#62-cicd-integration" title="Permanent link">&para;</a></h3>
<p><strong>GitHub Actions</strong> (example):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># .github/workflows/deploy-bixarena-infra.yml</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy Snapshot Function</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">nx run bixarena-infra-cdk:deploy:dev \</span>
<span class="w">      </span><span class="no">--stacks=&quot;BixarenaSnapshotStack-dev&quot; \</span>
<span class="w">      </span><span class="no">--require-approval=never</span>
</code></pre></div>
<hr />
<h2 id="phase-7-monitoring-observability">Phase 7: Monitoring &amp; Observability<a class="headerlink" href="#phase-7-monitoring-observability" title="Permanent link">&para;</a></h2>
<h3 id="71-cloudwatch-metrics">7.1 CloudWatch Metrics<a class="headerlink" href="#71-cloudwatch-metrics" title="Permanent link">&para;</a></h3>
<p><strong>Lambda Metrics (automatic):</strong></p>
<ul>
<li>Invocations</li>
<li>Duration</li>
<li>Errors</li>
<li>Throttles</li>
<li>Concurrent executions</li>
</ul>
<p><strong>Custom Metrics:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>

<span class="n">cloudwatch</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;cloudwatch&quot;</span><span class="p">)</span>

<span class="c1"># After snapshot generation</span>
<span class="n">cloudwatch</span><span class="o">.</span><span class="n">put_metric_data</span><span class="p">(</span>
    <span class="n">Namespace</span><span class="o">=</span><span class="s2">&quot;BixArena/Leaderboard&quot;</span><span class="p">,</span>
    <span class="n">MetricData</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;MetricName&quot;</span><span class="p">:</span> <span class="s2">&quot;SnapshotEntryCount&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;entry_count&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Unit&quot;</span><span class="p">:</span> <span class="s2">&quot;Count&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;MetricName&quot;</span><span class="p">:</span> <span class="s2">&quot;SnapshotGenerationDuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
            <span class="s2">&quot;Unit&quot;</span><span class="p">:</span> <span class="s2">&quot;Seconds&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
<h3 id="72-alarms">7.2 Alarms<a class="headerlink" href="#72-alarms" title="Permanent link">&para;</a></h3>
<p><strong>CDK Implementation:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">aws_cdk</span><span class="w"> </span><span class="kn">import</span> <span class="n">aws_cloudwatch</span> <span class="k">as</span> <span class="n">cloudwatch</span><span class="p">,</span> <span class="n">aws_sns</span> <span class="k">as</span> <span class="n">sns</span>

<span class="c1"># Create SNS topic for alerts</span>
<span class="n">alert_topic</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;SnapshotAlerts&quot;</span><span class="p">)</span>

<span class="c1"># Alarm on function errors</span>
<span class="n">error_alarm</span> <span class="o">=</span> <span class="n">cloudwatch</span><span class="o">.</span><span class="n">Alarm</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="s2">&quot;SnapshotErrorAlarm&quot;</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="n">snapshot_function</span><span class="o">.</span><span class="n">metric_errors</span><span class="p">(),</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">evaluation_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">alarm_description</span><span class="o">=</span><span class="s2">&quot;Leaderboard snapshot generation failed&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">error_alarm</span><span class="o">.</span><span class="n">add_alarm_action</span><span class="p">(</span><span class="n">cloudwatch_actions</span><span class="o">.</span><span class="n">SnsAction</span><span class="p">(</span><span class="n">alert_topic</span><span class="p">))</span>
</code></pre></div>
<h3 id="73-slack-notifications">7.3 Slack Notifications<a class="headerlink" href="#73-slack-notifications" title="Permanent link">&para;</a></h3>
<p><strong>Architecture:</strong></p>
<div class="highlight"><pre><span></span><code>Snapshot Lambda (success) ‚Üí SNS Topic ‚Üí Slack Notifier Lambda ‚Üí Slack Webhook API
</code></pre></div>
<p><strong>Slack Message Format:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;üéØ New Leaderboard Snapshot Generated!&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;blocks&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;section&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mrkdwn&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*Leaderboard Snapshot Generated* ‚úÖ\n\n*Leaderboard:* Overall\n*Snapshot ID:* snapshot_2026-01-09_02-00\n*Models Ranked:* 42\n*Total Evaluations:* 1,247\n*Bootstrap Iterations:* 1000\n*Duration:* 87 seconds&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;actions&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;elements&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;button&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;plain_text&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;View Leaderboard&quot;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://bixarena.io/leaderboard&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>CDK Implementation:</strong></p>
<p>Add to <code>leaderboard_snapshot_stack.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">aws_cdk</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">aws_lambda</span> <span class="k">as</span> <span class="n">lambda_</span><span class="p">,</span>
    <span class="n">aws_sns</span> <span class="k">as</span> <span class="n">sns</span><span class="p">,</span>
    <span class="n">aws_sns_subscriptions</span> <span class="k">as</span> <span class="n">subscriptions</span><span class="p">,</span>
    <span class="n">aws_secretsmanager</span> <span class="k">as</span> <span class="n">secretsmanager</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># SNS Topic for snapshot events</span>
<span class="n">snapshot_events_topic</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="s2">&quot;SnapshotEventsTopic&quot;</span><span class="p">,</span>
    <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Leaderboard Snapshot Events&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Slack webhook URL stored in Secrets Manager</span>
<span class="n">slack_webhook_secret</span> <span class="o">=</span> <span class="n">secretsmanager</span><span class="o">.</span><span class="n">Secret</span><span class="o">.</span><span class="n">from_secret_name_v2</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="s2">&quot;SlackWebhookSecret&quot;</span><span class="p">,</span>
    <span class="n">secret_name</span><span class="o">=</span><span class="s2">&quot;bixarena/slack/webhook-url&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Slack notification Lambda (inline for simplicity)</span>
<span class="n">slack_notifier</span> <span class="o">=</span> <span class="n">lambda_</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="s2">&quot;SlackNotifier&quot;</span><span class="p">,</span>
    <span class="n">runtime</span><span class="o">=</span><span class="n">lambda_</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">PYTHON_3_13</span><span class="p">,</span>
    <span class="n">handler</span><span class="o">=</span><span class="s2">&quot;index.handler&quot;</span><span class="p">,</span>
    <span class="n">code</span><span class="o">=</span><span class="n">lambda_</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_inline</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import json</span>
<span class="s2">import os</span>
<span class="s2">import urllib.request</span>
<span class="s2">import urllib.error</span>

<span class="s2">def handler(event, context):</span>
<span class="s2">    webhook_url = os.environ[&#39;SLACK_WEBHOOK_URL&#39;]</span>

<span class="s2">    # Parse SNS message</span>
<span class="s2">    for record in event[&#39;Records&#39;]:</span>
<span class="s2">        message = json.loads(record[&#39;Sns&#39;][&#39;Message&#39;])</span>

<span class="s2">        status = message.get(&#39;status&#39;, &#39;unknown&#39;)</span>
<span class="s2">        trigger_source = message.get(&#39;trigger_source&#39;, &#39;scheduled&#39;)</span>
<span class="s2">        triggered_by = message.get(&#39;triggered_by&#39;, &#39;System&#39;)</span>

<span class="s2">        # Build title and trigger info based on source</span>
<span class="s2">        if trigger_source == &#39;api&#39;:</span>
<span class="s2">            title = f&quot;üéØ Leaderboard Snapshot {&#39;Generated&#39; if status == &#39;success&#39; else &#39;Failed&#39;} (Manual)&quot;</span>
<span class="s2">            trigger_info = f&quot;*Triggered by:* </span><span class="si">{triggered_by}</span><span class="s2">&quot;</span>
<span class="s2">        else:</span>
<span class="s2">            title = f&quot;üéØ Leaderboard Snapshot {&#39;Generated&#39; if status == &#39;success&#39; else &#39;Failed&#39;} (Scheduled)&quot;</span>
<span class="s2">            trigger_info = f&quot;*Triggered by:* Automated daily job&quot;</span>

<span class="s2">        # Build status emoji and message</span>
<span class="s2">        if status == &#39;success&#39;:</span>
<span class="s2">            status_emoji = &quot;‚úÖ&quot;</span>
<span class="s2">            status_text = &quot;Snapshot Generated&quot;</span>
<span class="s2">        else:</span>
<span class="s2">            status_emoji = &quot;‚ùå&quot;</span>
<span class="s2">            status_text = &quot;Snapshot Failed&quot;</span>

<span class="s2">        # Build Slack message</span>
<span class="s2">        slack_message = {</span>
<span class="s2">            &#39;text&#39;: title,</span>
<span class="s2">            &#39;blocks&#39;: [</span>
<span class="s2">                {</span>
<span class="s2">                    &#39;type&#39;: &#39;section&#39;,</span>
<span class="s2">                    &#39;text&#39;: {</span>
<span class="s2">                        &#39;type&#39;: &#39;mrkdwn&#39;,</span>
<span class="s2">                        &#39;text&#39;: f&quot;*</span><span class="si">{status_text}</span><span class="s2">* </span><span class="si">{status_emoji}</span><span class="se">\\</span><span class="s2">n</span><span class="se">\\</span><span class="s2">n&quot;</span>
<span class="s2">                                f&quot;</span><span class="si">{trigger_info}</span><span class="se">\\</span><span class="s2">n&quot;</span>
<span class="s2">                                f&quot;*Leaderboard:* {message.get(&#39;leaderboard_id&#39;, &#39;N/A&#39;)}</span><span class="se">\\</span><span class="s2">n&quot;</span>
<span class="s2">                                + (f&quot;*Snapshot ID:* {message.get(&#39;snapshot_id&#39;, &#39;N/A&#39;)}</span><span class="se">\\</span><span class="s2">n&quot;</span>
<span class="s2">                                   f&quot;*Models Ranked:* {message.get(&#39;entry_count&#39;, &#39;N/A&#39;)}</span><span class="se">\\</span><span class="s2">n&quot;</span>
<span class="s2">                                   f&quot;*Total Evaluations:* {message.get(&#39;evaluation_count&#39;, &#39;N/A&#39;)}</span><span class="se">\\</span><span class="s2">n&quot;</span>
<span class="s2">                                   if status == &#39;success&#39; else</span>
<span class="s2">                                   f&quot;*Error:* {message.get(&#39;error&#39;, &#39;Unknown error&#39;)}</span><span class="se">\\</span><span class="s2">n&quot;) +</span>
<span class="s2">                                f&quot;*Duration:* {message.get(&#39;duration_seconds&#39;, &#39;N/A&#39;)}s&quot;</span>
<span class="s2">                    }</span>
<span class="s2">                },</span>
<span class="s2">                {</span>
<span class="s2">                    &#39;type&#39;: &#39;context&#39;,</span>
<span class="s2">                    &#39;elements&#39;: [</span>
<span class="s2">                        {</span>
<span class="s2">                            &#39;type&#39;: &#39;mrkdwn&#39;,</span>
<span class="s2">                            &#39;text&#39;: f&quot;Correlation ID: `{message.get(&#39;correlation_id&#39;, &#39;N/A&#39;)}`&quot;</span>
<span class="s2">                        }</span>
<span class="s2">                    ]</span>
<span class="s2">                }</span>
<span class="s2">            ]</span>
<span class="s2">        }</span>

<span class="s2">        # Add action button only for success</span>
<span class="s2">        if status == &#39;success&#39;:</span>
<span class="s2">            slack_message[&#39;blocks&#39;].append({</span>
<span class="s2">                &#39;type&#39;: &#39;actions&#39;,</span>
<span class="s2">                &#39;elements&#39;: [</span>
<span class="s2">                    {</span>
<span class="s2">                        &#39;type&#39;: &#39;button&#39;,</span>
<span class="s2">                        &#39;text&#39;: {&#39;type&#39;: &#39;plain_text&#39;, &#39;text&#39;: &#39;View Leaderboard&#39;},</span>
<span class="s2">                        &#39;url&#39;: &#39;https://bixarena.io/leaderboard&#39;</span>
<span class="s2">                    }</span>
<span class="s2">                ]</span>
<span class="s2">            })</span>

<span class="s2">        # Send to Slack</span>
<span class="s2">        req = urllib.request.Request(</span>
<span class="s2">            webhook_url,</span>
<span class="s2">            data=json.dumps(slack_message).encode(&#39;utf-8&#39;),</span>
<span class="s2">            headers={&#39;Content-Type&#39;: &#39;application/json&#39;}</span>
<span class="s2">        )</span>

<span class="s2">        try:</span>
<span class="s2">            urllib.request.urlopen(req)</span>
<span class="s2">            print(f&quot;Sent notification for snapshot: {message.get(&#39;snapshot_id&#39;)}&quot;)</span>
<span class="s2">        except urllib.error.HTTPError as e:</span>
<span class="s2">            print(f&quot;Failed to send Slack notification: </span><span class="si">{e}</span><span class="s2">&quot;)</span>
<span class="s2">            raise</span>

<span class="s2">    return {&#39;statusCode&#39;: 200}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;SLACK_WEBHOOK_URL&quot;</span><span class="p">:</span> <span class="n">slack_webhook_secret</span><span class="o">.</span><span class="n">secret_value</span><span class="o">.</span><span class="n">unsafe_unwrap</span><span class="p">(),</span>
    <span class="p">},</span>
    <span class="n">timeout</span><span class="o">=</span><span class="n">Duration</span><span class="o">.</span><span class="n">seconds</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Send Slack notifications for leaderboard snapshots&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Grant access to read Slack webhook secret</span>
<span class="n">slack_webhook_secret</span><span class="o">.</span><span class="n">grant_read</span><span class="p">(</span><span class="n">slack_notifier</span><span class="p">)</span>

<span class="c1"># Subscribe Slack notifier to SNS topic</span>
<span class="n">snapshot_events_topic</span><span class="o">.</span><span class="n">add_subscription</span><span class="p">(</span>
    <span class="n">subscriptions</span><span class="o">.</span><span class="n">LambdaSubscription</span><span class="p">(</span><span class="n">slack_notifier</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Update main snapshot Lambda to publish to SNS</span>
<span class="n">snapshot_function</span><span class="o">.</span><span class="n">add_environment</span><span class="p">(</span>
    <span class="s2">&quot;NOTIFICATION_TOPIC_ARN&quot;</span><span class="p">,</span> <span class="n">snapshot_events_topic</span><span class="o">.</span><span class="n">topic_arn</span>
<span class="p">)</span>
<span class="n">snapshot_events_topic</span><span class="o">.</span><span class="n">grant_publish</span><span class="p">(</span><span class="n">snapshot_function</span><span class="p">)</span>
</code></pre></div>
<p><strong>Update Lambda handler to publish SNS:</strong></p>
<p>In <code>lambda_function.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">UTC</span><span class="p">,</span> <span class="n">datetime</span>

<span class="n">sns_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sns&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># ... existing snapshot generation code ...</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">SnapshotGenerator</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_snapshot</span><span class="p">()</span>

        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

        <span class="c1"># Publish success notification to SNS</span>
        <span class="n">topic_arn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NOTIFICATION_TOPIC_ARN&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">topic_arn</span><span class="p">:</span>
            <span class="n">sns_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="n">TopicArn</span><span class="o">=</span><span class="n">topic_arn</span><span class="p">,</span>
                <span class="n">Subject</span><span class="o">=</span><span class="s2">&quot;Leaderboard Snapshot Generated&quot;</span><span class="p">,</span>
                <span class="n">Message</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;leaderboard_id&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">leaderboard_id</span><span class="p">,</span>
                    <span class="s2">&quot;snapshot_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;snapshot_id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;entry_count&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;entry_count&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;evaluation_count&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;evaluation_count&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;duration_seconds&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="p">}),</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Snapshot created successfully: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Snapshot generated successfully&quot;</span><span class="p">,</span>
                <span class="s2">&quot;snapshot_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;snapshot_id&quot;</span><span class="p">],</span>
                <span class="s2">&quot;entry_count&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;entry_count&quot;</span><span class="p">],</span>
                <span class="s2">&quot;evaluation_count&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;evaluation_count&quot;</span><span class="p">],</span>
                <span class="s2">&quot;duration_seconds&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
            <span class="p">}),</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Publish failure notification</span>
        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

        <span class="n">topic_arn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NOTIFICATION_TOPIC_ARN&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">topic_arn</span><span class="p">:</span>
            <span class="n">sns_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="n">TopicArn</span><span class="o">=</span><span class="n">topic_arn</span><span class="p">,</span>
                <span class="n">Subject</span><span class="o">=</span><span class="s2">&quot;Leaderboard Snapshot Failed&quot;</span><span class="p">,</span>
                <span class="n">Message</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failure&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;leaderboard_id&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">leaderboard_id</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;duration_seconds&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="p">}),</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate snapshot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>
<p><strong>Slack Webhook Setup:</strong></p>
<ol>
<li>Create Slack App at https://api.slack.com/apps</li>
<li>Enable Incoming Webhooks</li>
<li>Add webhook to desired channel (e.g., <code>#bixarena-alerts</code>)</li>
<li>Copy webhook URL</li>
<li>Store in AWS Secrets Manager:</li>
</ol>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>secretsmanager<span class="w"> </span>create-secret<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bixarena/slack/webhook-url<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--secret-string<span class="w"> </span><span class="s2">&quot;https://hooks.slack.com/services/YOUR/WEBHOOK/URL&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--profile<span class="w"> </span>bixarena-dev-Developer
</code></pre></div>
<hr />
<h2 id="implementation-timeline">Implementation Timeline<a class="headerlink" href="#implementation-timeline" title="Permanent link">&para;</a></h2>
<h3 id="week-1-foundation">Week 1: Foundation<a class="headerlink" href="#week-1-foundation" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Create <code>bixarena-leaderboard</code> library in <code>libs/bixarena/leaderboard/python/</code></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Extract business logic from <code>apps/bixarena/tools/bixarena_tools/leaderboard/</code></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Write unit tests for library (snapshot, ranking, database modules)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Update <code>bixarena-tools</code> CLI to depend on <code>bixarena-leaderboard</code> library</li>
</ul>
<h3 id="week-2-lambda-function">Week 2: Lambda Function<a class="headerlink" href="#week-2-lambda-function" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Create Lambda function code and Dockerfile</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Test Lambda locally with Docker</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Create CDK stack for Lambda and EventBridge</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Set up Slack webhook in AWS Secrets Manager</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Add SNS topic and Slack notifier Lambda</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Deploy to dev environment</li>
</ul>
<h3 id="week-3-ai-service-integration">Week 3: AI Service Integration<a class="headerlink" href="#week-3-ai-service-integration" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Add admin endpoint to AI service with async Lambda invocation</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Implement JWT authentication with admin role validation</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Add boto3 dependency for Lambda invocation</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Grant ECS task role permission to invoke Lambda</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Add SNAPSHOT_LAMBDA_NAME environment variable</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Test end-to-end authentication and async invocation flow</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Deploy to dev environment</li>
</ul>
<h3 id="week-4-testing-documentation">Week 4: Testing &amp; Documentation<a class="headerlink" href="#week-4-testing-documentation" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Integration testing in dev environment</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Test Slack notifications (success and failure scenarios)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Performance testing (snapshot generation time)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Verify auto-publish functionality</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Documentation and runbooks</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Deploy to stage/prod</li>
</ul>
<hr />
<h2 id="cost-estimation">Cost Estimation<a class="headerlink" href="#cost-estimation" title="Permanent link">&para;</a></h2>
<h3 id="lambda-function">Lambda Function<a class="headerlink" href="#lambda-function" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Execution</strong>: Daily at 2 AM, ~2 minutes duration</li>
<li><strong>Memory</strong>: 2GB</li>
<li><strong>Cost per month</strong>: ~$0.05 (negligible)</li>
</ul>
<h3 id="rds-proxy-if-used">RDS Proxy (if used)<a class="headerlink" href="#rds-proxy-if-used" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Cost</strong>: ~$15/month per proxy</li>
<li><strong>Note</strong>: Only if connection pooling is needed</li>
</ul>
<h3 id="cloudwatch-logs">CloudWatch Logs<a class="headerlink" href="#cloudwatch-logs" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Retention</strong>: 30 days</li>
<li><strong>Cost</strong>: ~$0.50/month</li>
</ul>
<p><strong>Total estimated cost</strong>: &lt;$20/month</p>
<hr />
<h2 id="decisions-made">Decisions Made<a class="headerlink" href="#decisions-made" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>Snapshot visibility</strong>: ‚úÖ Auto-publish to public (set <code>visible=true</code> after generation)</li>
<li><strong>Notification</strong>: ‚úÖ Send Slack notification when snapshot completes</li>
<li><strong>Multiple leaderboards</strong>: ‚úÖ Start with "overall" leaderboard, design for future expansion (open-source, multimodal, etc.)</li>
<li><strong>Execution time</strong>: ‚úÖ Confirmed to be &lt; 15 minutes (within Lambda limits)</li>
<li><strong>On-demand execution</strong>: ‚úÖ Async Lambda invocation (returns HTTP 202 immediately, no timeout issues)</li>
<li><strong>Metadata tracking</strong>: ‚úÖ Track trigger_source, triggered_by, correlation_id for audit trail</li>
<li><strong>Security</strong>:<ul>
<li>‚úÖ IAM least privilege for Lambda and ECS task roles</li>
<li>‚úÖ Database credentials in AWS Secrets Manager</li>
<li>‚úÖ Lambda in VPC private subnet with security groups</li>
<li>‚úÖ Input validation (whitelist leaderboard IDs, validate ranges)</li>
<li>‚úÖ JWT authentication with admin role required</li>
<li>‚úÖ Rate limiting on API Gateway (100 requests/day)</li>
</ul>
</li>
<li><strong>Retention</strong>: TBD - Will address in future iteration</li>
</ol>
<hr />
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">&para;</a></h2>
<h3 id="ready-to-begin-implementation">Ready to Begin Implementation ‚úÖ<a class="headerlink" href="#ready-to-begin-implementation" title="Permanent link">&para;</a></h3>
<p>All decisions have been made:</p>
<ul>
<li>‚úÖ Lambda packaging: <strong>Container Image (Docker)</strong></li>
<li>‚úÖ Auto-publish snapshots: <strong>Yes</strong> (set <code>visible=true</code>)</li>
<li>‚úÖ Notifications: <strong>Slack</strong> via SNS ‚Üí Lambda ‚Üí Webhook</li>
<li>‚úÖ Initial scope: <strong>"overall" leaderboard</strong> (extensible design)</li>
<li>‚úÖ Execution time: <strong>&lt; 15 minutes</strong> (within Lambda limits)</li>
<li>‚úÖ On-demand execution: <strong>Async Lambda invocation</strong> (HTTP 202, no timeout)</li>
<li>‚úÖ Security: <strong>Defense-in-depth</strong> (IAM, Secrets Manager, VPC, input validation)</li>
<li>‚úÖ Audit logging: <strong>Metadata tracking</strong> (trigger_source, triggered_by, correlation_id)</li>
</ul>
<h3 id="recommended-implementation-order">Recommended Implementation Order<a class="headerlink" href="#recommended-implementation-order" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>Phase 1 (Week 1)</strong>: Extract leaderboard library</p>
<ul>
<li>Create <code>libs/bixarena/leaderboard/python/</code> (Nx: <code>bixarena-leaderboard-python</code>, Python: <code>bixarena-leaderboard</code>)</li>
<li>Move business logic from <code>apps/bixarena/tools/bixarena_tools/leaderboard/</code></li>
<li>Add <code>auto_publish</code> parameter to <code>SnapshotGenerator.generate_snapshot()</code></li>
<li>Write unit tests for snapshot, ranking, and database modules</li>
</ul>
</li>
<li>
<p><strong>Phase 2 (Week 2)</strong>: Build Lambda function</p>
<ul>
<li>Create Docker-based Lambda</li>
<li>Add SNS notification logic</li>
<li>Set up CDK stack with Slack integration</li>
<li>Test locally with <code>docker run</code></li>
</ul>
</li>
<li>
<p><strong>Phase 3 (Week 3)</strong>: Add AI service endpoint</p>
<ul>
<li>Create <code>/admin/generate-snapshot</code> endpoint with async Lambda invocation</li>
<li>Implement JWT authentication with admin role validation</li>
<li>Grant ECS task role permission to invoke Lambda</li>
<li>Add SNAPSHOT_LAMBDA_NAME environment variable</li>
<li>Deploy to dev environment</li>
</ul>
</li>
<li>
<p><strong>Phase 4 (Week 4)</strong>: Test and deploy</p>
<ul>
<li>Integration testing</li>
<li>Verify Slack notifications</li>
<li>Deploy to stage/prod</li>
</ul>
</li>
</ol>
<h3 id="quick-start-command">Quick Start Command<a class="headerlink" href="#quick-start-command" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Create leaderboard library</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>libs/bixarena/leaderboard/python/bixarena_leaderboard
<span class="nb">cd</span><span class="w"> </span>libs/bixarena/leaderboard/python

<span class="c1"># Initialize Python package</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>pyproject.toml<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">[project]</span>
<span class="s">name = &quot;bixarena-leaderboard&quot;</span>
<span class="s">version = &quot;1.0.0&quot;</span>
<span class="s">description = &quot;BixArena leaderboard snapshot generation and ranking algorithms&quot;</span>
<span class="s">requires-python = &quot;==3.13.3&quot;</span>
<span class="s">dependencies = [</span>
<span class="s">    &quot;numpy&gt;=1.26.0&quot;,</span>
<span class="s">    &quot;psycopg[binary]&gt;=3.0.0&quot;,</span>
<span class="s">    &quot;scipy&gt;=1.11.0&quot;,</span>
<span class="s">]</span>

<span class="s">[tool.hatch.build.targets.wheel]</span>
<span class="s">packages = [&quot;bixarena_leaderboard&quot;]</span>

<span class="s">[build-system]</span>
<span class="s">requires = [&quot;hatchling&quot;]</span>
<span class="s">build-backend = &quot;hatchling.build&quot;</span>
<span class="s">EOF</span>

<span class="c1"># Initialize Nx project</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>project.json<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">{</span>
<span class="s">  &quot;name&quot;: &quot;bixarena-leaderboard-python&quot;,</span>
<span class="s">  &quot;projectType&quot;: &quot;library&quot;,</span>
<span class="s">  &quot;targets&quot;: {</span>
<span class="s">    &quot;build&quot;: {</span>
<span class="s">      &quot;executor&quot;: &quot;@nxlv/python:build&quot;,</span>
<span class="s">      &quot;outputs&quot;: [&quot;{projectRoot}/dist&quot;]</span>
<span class="s">    },</span>
<span class="s">    &quot;test&quot;: {</span>
<span class="s">      &quot;executor&quot;: &quot;@nxlv/python:run-commands&quot;,</span>
<span class="s">      &quot;options&quot;: {</span>
<span class="s">        &quot;command&quot;: &quot;uv run pytest tests/&quot;,</span>
<span class="s">        &quot;cwd&quot;: &quot;{projectRoot}&quot;</span>
<span class="s">      }</span>
<span class="s">    }</span>
<span class="s">  },</span>
<span class="s">  &quot;tags&quot;: [&quot;type:library&quot;, &quot;scope:backend&quot;, &quot;language:python&quot;, &quot;domain:leaderboard&quot;]</span>
<span class="s">}</span>
<span class="s">EOF</span>

<span class="c1"># Create package structure</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>bixarena_leaderboard<span class="w"> </span>tests
touch<span class="w"> </span>bixarena_leaderboard/<span class="o">{</span>__init__.py,snapshot.py,database.py,ranking.py,config.py<span class="o">}</span>
touch<span class="w"> </span>tests/<span class="o">{</span>__init__.py,test_snapshot.py,test_database.py,test_ranking.py<span class="o">}</span>

<span class="c1"># Start implementation!</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "navigation.footer", "navigation.sections", "navigation.tabs", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>