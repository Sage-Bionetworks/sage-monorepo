variables:
  CI: "1"
  # Workaround for locally issued TLS certs
  DOCKER_TLS_CERTDIR: ''

  # Staging variables
  STAGING_CONTAINER_NAME: $CI_REGISTRY_IMAGE:${CI_COMMIT_SHORT_SHA}-${CI_COMMIT_REF_NAME}
  STAGING_CONTAINER_LABEL: iatlas-api
  STAGING_DB_HOST: iatlas-staging-us-west-2.cluster-cfb68nhqxoz9.us-west-2.rds.amazonaws.com
  STAGING_DB_USER: postgres
  STAGING_DOCKER_HOST: ip-10-220-11-144.us-west-2.compute.internal

stages:
  - test_code
  - publish_coverage
  - build_container
  - deploy_staging

tests:
  only:
    - merge_requests
  except:
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "staging"
  stage: test_code
  image: python:3.8-alpine
  script:
    - apk add postgresql-libs
    - apk add --no-cache --virtual .build-deps gcc musl-dev postgresql-dev && pip install --no-cache-dir -r ./requirements.txt && apk del --no-cache .build-deps
    - pip install pytest pytest-cov pytest-xdist
    - export POSTGRES_DB=$POSTGRES_DB
    - export POSTGRES_HOST=$POSTGRES_HOST
    - export POSTGRES_PASSWORD=$POSTGRES_PASSWORD
    - export POSTGRES_USER=$POSTGRES_USER
    - pytest --cov --cov-report html -n auto
  artifacts:
    expose_as: "coverage-initial"
    paths:
      - coverage
    expire_in: 30 days

tests:coverage-report:
  only:
    - staging
    - master
  stage: test_code
  image: python:3.8-alpine
  script:
    - apk add postgresql-libs
    - apk add --no-cache --virtual .build-deps gcc musl-dev postgresql-dev && pip install --no-cache-dir -r ./requirements.txt && apk del --no-cache .build-deps
    - pip install pytest pytest-cov pytest-xdist
    - export POSTGRES_DB=$POSTGRES_DB
    - export POSTGRES_HOST=$POSTGRES_HOST
    - export POSTGRES_PASSWORD=$POSTGRES_PASSWORD
    - export POSTGRES_USER=$POSTGRES_USER
    - pytest --cov --cov-report html --cov-report xml:coverage/iatlas-api_coverage_$CI_MERGE_REQUEST_TARGET_BRANCH_NAME.xml --cov-report term:skip-covered -n auto
    - coverage report --skip-covered | grep TOTAL
  artifacts:
    reports:
      cobertura: coverage/iatlas-api_coverage_$CI_MERGE_REQUEST_TARGET_BRANCH_NAME.xml

pages:
  only:
    - merge_requests
  except:
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "staging"
  stage: publish_coverage
  dependencies:
    - tests
  script:
    - mv ./coverage/ ./public/
    - echo "Coverage available at $CI_PAGES_URL/"
  artifacts:
    expose_as: "coverage"
    paths:
      - public
    expire_in: 30 days

Build Container:
  only:
    - staging
  stage: build_container
  image: docker:19.03.1-dind
  services:
    - name: docker:19.03.1-dind
  script:
    - export FLASK_ENV=staging
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker build -t $STAGING_CONTAINER_NAME .
    - docker push $STAGING_CONTAINER_NAME

Deploy to Staging:
  only:
    - staging
  stage: deploy_staging
  image: eugenmayer/docker-client:latest
  script:
    # Echo the RSA key into the correct location
    - mkdir -p ~/.ssh && echo ${STAGING_DOCKER_SSH_PRIV_KEY} > ~/.ssh/id_rsa.pub
    # Set the remote Docker endpoint
    - export DOCKER_HOST=ssh://ubuntu@${STAGING_DOCKER_HOST}:22
    # Stop the existing container
    - docker stop ${STAGING_CONTAINER_NAME}
    - docker ps -a
    - docker run --rm -d -p 80:80 --name ${STAGING_CONTAINER_LABEL} -e POSTGRES_HOST=${STAGING_DB_HOST} -e POSTGRES_USER=${STAGING_DB_USER} -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD} -e POSTGRES_DB=${STAGING_DB_NAME} -e POSTGRES_PORT=5432 ${STAGING_CONTAINER_NAME}