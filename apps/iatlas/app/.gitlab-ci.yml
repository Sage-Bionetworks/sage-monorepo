variables:
  # Used for deployment command.  The secret values are in Gitlab secrets
  SHINYAPPS_ACCOUNT_NAME: isb-cgc
  # So we can set the R version to build against in one place
  R_VERSION: "3.6.2"

stages:
  - build_container
  #- test
  - deploy_to_staging
  - deploy_to_prod

Build Container:
  stage: build_container
  image: docker:19.03.1-dind
  services:
    - docker:19.03.1-dind
  only:
    refs:
      - feature/feather_file_structure
    changes:
      - renv.lock
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - export RENV_HASH=`md5sum renv.lock | awk '{print $1}'`
    - docker build
      --build-arg R_VERSION
      --cache-from ${CI_REGISTRY_IMAGE}-renv:latest
      --tag ${CI_REGISTRY_IMAGE}:renv-latest
      --tag ${CI_REGISTRY_IMAGE}:renv-${RENV_HASH}
      -f Dockerfile.build .
    - docker push ${CI_REGISTRY_IMAGE}:renv-latest
    - docker push ${CI_REGISTRY_IMAGE}:renv-${RENV_HASH}

# Run Tests:
#   stage: test
#   image: rocker/verse:${R_VERSION}
#   script:
#     - echo "Tests run here!"

Deploy To Staging:
  stage: deploy_to_staging
  image: rocker/verse:${R_VERSION}
  only:
    - staging
  variables:
    STAGING_DB_NAME: iatlas_staging
    STAGING_DB_HOST: sage-test.cau5la50px0r.us-west-2.rds.amazonaws.com
    STAGING_DB_USER: postgres
  script:
    - pwd
    # Gather all required packages
    - R -e "renv::restore()"
    # Set the creds to use with Shinyapps.io
    - R -e
      "rsconnect::setAccountInfo(
      name=\"${SHINYAPPS_ACCOUNT_NAME}\",
      token=\"${SHINYAPPS_TOKEN}\",
      secret=\"${SHINYAPPS_SECRET}\"
      )"
    # Deploy it to Shinyapps.io
    - R -e "rsconnect::deployApp(appName=\"iatlas-staging\", appTitle=\"iAtlas Staging\")"
