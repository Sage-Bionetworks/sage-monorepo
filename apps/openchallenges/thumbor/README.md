# OpenChallenges Thumbor

## Overview

This component is based on [Thumbor S3 Docker].

## Usage

### Prepare the service

Run this command to prepare this project, including creating the config file `.env`.

```console
nx create-config openchallenges-thumbor
```

> **Note** The task `prepare` does not overwrites the config file `.env` if it already exists.

### Build the Docker image

```console
nx build-image openchallenges-thumbor
```

### Start Thumbor

Start Thumbor and its dependencies:

```console
nx serve-detach openchallenges-thumbor
```

### Update an image to AWS S3 bucket

Add images to the AWS S3 bucket `openchallenges-img`.

See below for information on how to create and configure the AWS S3 buckets.

### Access the image with Thumbor

Open this link and you should see the resized image:

- http://localhost:8889/unsafe/600x600/triforce.png

Open this ling when the API Gateway is running:

- http://localhost:8082/img/unsafe/triforce.png

## Using Amazon S3 buckets as object storage

### Create the buckets

We need two buckets, one to store the original images and one to store the images generated by
Thumbor (result images).

- `openchallenges-img`
- `openchallenges-img-cache`

### Add the sample image

In the bucket `openchallenges-img`, create the folder `img` and add the [Triforce image] to it.

### Create Thumbor IAM user

Create the IAM user `openchallenges-thumbor` and create an access key for this user.

Assign the following policy to this user so that Thumbor. This gives Thumbor read access to the
bucket that stores the original images and read-write access to the bucket that stores the result
images.

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["s3:ListBucket", "s3:GetObject*"],
      "Resource": [
        "arn:aws:s3:::openchallenges-img",
        "arn:aws:s3:::openchallenges-img/*",
        "arn:aws:s3:::openchallenges-img-cache",
        "arn:aws:s3:::openchallenges-img-cache/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": "s3:*Object",
      "Resource": ["arn:aws:s3:::openchallenges-img-cache/*"]
    }
  ]
}
```

### Update Thumbor config

Replace the file `.env` with a copy of `.env.example.aws`. Replace the access key properties with
the values stored in LastPass.

## Notes

- By default, Thumbor starts as many processes as the number of cores available.

## References

- https://github.com/thumbor/thumbor
- https://github.com/thumbor/thumbor-aws
- https://github.com/beeyev/thumbor-s3-docker

<!-- Links -->

[Thumbor S3 Docker]: https://github.com/beeyev/thumbor-s3-docker
[Triforce image]: https://static.wikia.nocookie.net/zelda_gamepedia_en/images/7/70/ALBW_Triforce_Artwork.png/revision/latest/scale-to-width-down/1000?cb=20140604184126&format=original
